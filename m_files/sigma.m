function [x0] = sigma(optim_var)
% SIGMA
%   [X0] = SIGMA(Z2)  Maps horizontal velocity of hips just before impact to state of the system just before impact.

%Eric Westervelt
%12-Nov-2016 22:00:20

modelP;
a = optim_var(1:28); b = optim_var(29); m = optim_var(30); z2 = optim_var(31);


a0=a(1); a1=a(2); a2=a(3); a3=a(4); a4=a(5); a5=a(6); a6=a(7); 
b0=a(8); b1=a(9); b2=a(10); b3=a(11); b4=a(12); b5=a(13); b6=a(14); 
c0=a(15); c1=a(16); c2=a(17); c3=a(18); c4=a(19); c5=a(20); c6=a(21); 
d0=a(22); d1=a(23); d2=a(24); d3=a(25); d4=a(26); d5=a(27); d6=a(28); 

hd1 = a6;
hd2 = b6;
hd3 = c6;
hd4 = d6;

jac_hd1 = -(6*(a5 - a6))/m;
jac_hd2 = -(6*(b5 - b6))/m;
jac_hd3 = -(6*(c5 - c6))/m;
jac_hd4 = -(6*(d5 - d6))/m;

q(1) = hd1;
q(2) = hd2;
q(3) = hd3;
q(4) = hd4;
q(5) = - b - hd1 - hd3/2 - m;
dq(1) = -(2*jac_hd1*z2)/(2*XX1 + 4*XX3 + 4*XX4 + 2*XX1*jac_hd1 + XX1* ...
        jac_hd3 + 2*XX3*jac_hd1 - 2*XX3*jac_hd2 + 2*XX4*jac_hd1 + 2*XX3* ...
        jac_hd3 - 2*XX4*jac_hd2 - 2*XX4*jac_hd4 + 2*L3^2*M1 + 2*L4^2*M1 + ...
         4*L3^2*M3 + 4*L3^2*M4 + 4*L4^2*M3 + 4*L4^2*M4 + 2*M1*MY1^2 + 4* ...
        M3*MY3^2 + 4*M4*MY4^2 + 2*M1*MZ1^2 + 4*M3*MZ3^2 + 4*M4*MZ4^2 - 4* ...
        L3*M3*MZ3 - 4*L4*M4*MZ4 - 4*L3^2*M4*cos(hd1 - hd2) + L3^2*M1* ...
        jac_hd3 + 2*L3^2*M4*jac_hd1 - L4^2*M1*jac_hd3 + 2*L3^2*M3* ...
        jac_hd3 - 2*L3^2*M4*jac_hd2 + 2*L3^2*M4*jac_hd3 - 2*L4^2*M3* ...
        jac_hd3 - 2*L4^2*M4*jac_hd3 + 2*M1*MY1^2*jac_hd1 + M1*MY1^2* ...
        jac_hd3 + 2*M3*MY3^2*jac_hd1 - 2*M3*MY3^2*jac_hd2 + 2*M3*MY3^2* ...
        jac_hd3 + 2*M4*MY4^2*jac_hd1 - 2*M4*MY4^2*jac_hd2 - 2*M4*MY4^2* ...
        jac_hd4 + 2*M1*MZ1^2*jac_hd1 + M1*MZ1^2*jac_hd3 + 2*M3*MZ3^2* ...
        jac_hd1 - 2*M3*MZ3^2*jac_hd2 + 2*M3*MZ3^2*jac_hd3 + 2*M4*MZ4^2* ...
        jac_hd1 - 2*M4*MZ4^2*jac_hd2 - 2*M4*MZ4^2*jac_hd4 - 4*L3*M4*MZ4* ...
        cos(hd1 - hd2 - hd4) + 4*L3*L4*M1*cos(hd3) + 8*L3*L4*M3* ...
        cos(hd3) + 4*L3*L4*M4*cos(hd3) + 4*L3*M4*MY4*sin(hd1 - hd2 - ...
         hd4) - 4*L3*M1*MZ1*cos(hd1) - 4*L4*M3*MZ3*cos(hd3) + 4*L3*M4* ...
        MZ4*cos(hd4) + 4*L3*M1*MY1*sin(hd1) + 4*L4*M3*MY3*sin(hd3) + 4* ...
        L3*M4*MY4*sin(hd4) - 4*L3*M3*MZ3*cos(hd1 - hd2) + 4*L3*M3*MY3* ...
        sin(hd1 - hd2) - 4*L4*M4*MZ4*cos(hd1 - hd2 + hd3 - hd4) + 4*L4* ...
        M4*MY4*sin(hd1 - hd2 + hd3 - hd4) - 4*L3*L4*M4*cos(hd1 - hd2 + ...
         hd3) - 4*L4*M3*MZ3*cos(hd1 - hd2 + hd3) - 2*L3*M3*MZ3*jac_hd3 + ...
         2*L4*M4*MZ4*jac_hd3 + 4*L4*M3*MY3*sin(hd1 - hd2 + hd3) - 2*L3^2* ...
        M4*jac_hd1*cos(hd1 - hd2) + 2*L3^2*M4*jac_hd2*cos(hd1 - hd2) - 2* ...
        L3^2*M4*jac_hd3*cos(hd1 - hd2) - 4*L4*M1*MZ1*cos(hd1 + hd3) + 4* ...
        L4*M1*MY1*sin(hd1 + hd3) - 2*L3*L4*M4*jac_hd1*cos(hd1 - hd2 + ...
         hd3) + 2*L3*L4*M4*jac_hd2*cos(hd1 - hd2 + hd3) - 2*L4*M3*MZ3* ...
        jac_hd1*cos(hd1 - hd2 + hd3) + 2*L4*M3*MZ3*jac_hd2*cos(hd1 - ...
         hd2 + hd3) + 2*L4*M3*MY3*jac_hd1*sin(hd1 - hd2 + hd3) - 2*L4*M3* ...
        MY3*jac_hd2*sin(hd1 - hd2 + hd3) - 2*L4*M1*MZ1*jac_hd1*cos(hd1 + ...
         hd3) + 2*L4*M1*MY1*jac_hd1*sin(hd1 + hd3) - 2*L3*M4*MZ4*jac_hd1* ...
        cos(hd1 - hd2 - hd4) + 2*L3*M4*MZ4*jac_hd2*cos(hd1 - hd2 - hd4) - ...
         2*L3*M4*MZ4*jac_hd3*cos(hd1 - hd2 - hd4) + 2*L3*M4*MZ4*jac_hd4* ...
        cos(hd1 - hd2 - hd4) + 2*L3*M4*MY4*jac_hd1*sin(hd1 - hd2 - hd4) - ...
         2*L3*M4*MY4*jac_hd2*sin(hd1 - hd2 - hd4) + 2*L3*M4*MY4*jac_hd3* ...
        sin(hd1 - hd2 - hd4) - 2*L3*M4*MY4*jac_hd4*sin(hd1 - hd2 - hd4) - ...
         2*L3*M1*MZ1*jac_hd1*cos(hd1) - 2*L3*M1*MZ1*jac_hd3*cos(hd1) + 4* ...
        L3*M4*MZ4*jac_hd1*cos(hd4) - 4*L3*M4*MZ4*jac_hd2*cos(hd4) + 2*L3* ...
        M4*MZ4*jac_hd3*cos(hd4) - 2*L3*M4*MZ4*jac_hd4*cos(hd4) + 2*L3*M1* ...
        MY1*jac_hd1*sin(hd1) + 2*L3*M1*MY1*jac_hd3*sin(hd1) + 4*L3*M4* ...
        MY4*jac_hd1*sin(hd4) - 4*L3*M4*MY4*jac_hd2*sin(hd4) + 2*L3*M4* ...
        MY4*jac_hd3*sin(hd4) - 2*L3*M4*MY4*jac_hd4*sin(hd4) - 2*L3*M3* ...
        MZ3*jac_hd1*cos(hd1 - hd2) + 2*L3*M3*MZ3*jac_hd2*cos(hd1 - hd2) - ...
         2*L3*M3*MZ3*jac_hd3*cos(hd1 - hd2) + 2*L3*M3*MY3*jac_hd1* ...
        sin(hd1 - hd2) - 2*L3*M3*MY3*jac_hd2*sin(hd1 - hd2) + 2*L3*M3* ...
        MY3*jac_hd3*sin(hd1 - hd2) - 2*L4*M4*MZ4*jac_hd1*cos(hd1 - hd2 + ...
         hd3 - hd4) + 2*L4*M4*MZ4*jac_hd2*cos(hd1 - hd2 + hd3 - hd4) + 2* ...
        L4*M4*MZ4*jac_hd4*cos(hd1 - hd2 + hd3 - hd4) + 2*L4*M4*MY4* ...
        jac_hd1*sin(hd1 - hd2 + hd3 - hd4) - 2*L4*M4*MY4*jac_hd2* ...
        sin(hd1 - hd2 + hd3 - hd4) - 2*L4*M4*MY4*jac_hd4*sin(hd1 - hd2 + ...
         hd3 - hd4));
dq(2) = -(2*jac_hd2*z2)/(2*XX1 + 4*XX3 + 4*XX4 + 2*XX1*jac_hd1 + XX1* ...
        jac_hd3 + 2*XX3*jac_hd1 - 2*XX3*jac_hd2 + 2*XX4*jac_hd1 + 2*XX3* ...
        jac_hd3 - 2*XX4*jac_hd2 - 2*XX4*jac_hd4 + 2*L3^2*M1 + 2*L4^2*M1 + ...
         4*L3^2*M3 + 4*L3^2*M4 + 4*L4^2*M3 + 4*L4^2*M4 + 2*M1*MY1^2 + 4* ...
        M3*MY3^2 + 4*M4*MY4^2 + 2*M1*MZ1^2 + 4*M3*MZ3^2 + 4*M4*MZ4^2 - 4* ...
        L3*M3*MZ3 - 4*L4*M4*MZ4 - 4*L3^2*M4*cos(hd1 - hd2) + L3^2*M1* ...
        jac_hd3 + 2*L3^2*M4*jac_hd1 - L4^2*M1*jac_hd3 + 2*L3^2*M3* ...
        jac_hd3 - 2*L3^2*M4*jac_hd2 + 2*L3^2*M4*jac_hd3 - 2*L4^2*M3* ...
        jac_hd3 - 2*L4^2*M4*jac_hd3 + 2*M1*MY1^2*jac_hd1 + M1*MY1^2* ...
        jac_hd3 + 2*M3*MY3^2*jac_hd1 - 2*M3*MY3^2*jac_hd2 + 2*M3*MY3^2* ...
        jac_hd3 + 2*M4*MY4^2*jac_hd1 - 2*M4*MY4^2*jac_hd2 - 2*M4*MY4^2* ...
        jac_hd4 + 2*M1*MZ1^2*jac_hd1 + M1*MZ1^2*jac_hd3 + 2*M3*MZ3^2* ...
        jac_hd1 - 2*M3*MZ3^2*jac_hd2 + 2*M3*MZ3^2*jac_hd3 + 2*M4*MZ4^2* ...
        jac_hd1 - 2*M4*MZ4^2*jac_hd2 - 2*M4*MZ4^2*jac_hd4 - 4*L3*M4*MZ4* ...
        cos(hd1 - hd2 - hd4) + 4*L3*L4*M1*cos(hd3) + 8*L3*L4*M3* ...
        cos(hd3) + 4*L3*L4*M4*cos(hd3) + 4*L3*M4*MY4*sin(hd1 - hd2 - ...
         hd4) - 4*L3*M1*MZ1*cos(hd1) - 4*L4*M3*MZ3*cos(hd3) + 4*L3*M4* ...
        MZ4*cos(hd4) + 4*L3*M1*MY1*sin(hd1) + 4*L4*M3*MY3*sin(hd3) + 4* ...
        L3*M4*MY4*sin(hd4) - 4*L3*M3*MZ3*cos(hd1 - hd2) + 4*L3*M3*MY3* ...
        sin(hd1 - hd2) - 4*L4*M4*MZ4*cos(hd1 - hd2 + hd3 - hd4) + 4*L4* ...
        M4*MY4*sin(hd1 - hd2 + hd3 - hd4) - 4*L3*L4*M4*cos(hd1 - hd2 + ...
         hd3) - 4*L4*M3*MZ3*cos(hd1 - hd2 + hd3) - 2*L3*M3*MZ3*jac_hd3 + ...
         2*L4*M4*MZ4*jac_hd3 + 4*L4*M3*MY3*sin(hd1 - hd2 + hd3) - 2*L3^2* ...
        M4*jac_hd1*cos(hd1 - hd2) + 2*L3^2*M4*jac_hd2*cos(hd1 - hd2) - 2* ...
        L3^2*M4*jac_hd3*cos(hd1 - hd2) - 4*L4*M1*MZ1*cos(hd1 + hd3) + 4* ...
        L4*M1*MY1*sin(hd1 + hd3) - 2*L3*L4*M4*jac_hd1*cos(hd1 - hd2 + ...
         hd3) + 2*L3*L4*M4*jac_hd2*cos(hd1 - hd2 + hd3) - 2*L4*M3*MZ3* ...
        jac_hd1*cos(hd1 - hd2 + hd3) + 2*L4*M3*MZ3*jac_hd2*cos(hd1 - ...
         hd2 + hd3) + 2*L4*M3*MY3*jac_hd1*sin(hd1 - hd2 + hd3) - 2*L4*M3* ...
        MY3*jac_hd2*sin(hd1 - hd2 + hd3) - 2*L4*M1*MZ1*jac_hd1*cos(hd1 + ...
         hd3) + 2*L4*M1*MY1*jac_hd1*sin(hd1 + hd3) - 2*L3*M4*MZ4*jac_hd1* ...
        cos(hd1 - hd2 - hd4) + 2*L3*M4*MZ4*jac_hd2*cos(hd1 - hd2 - hd4) - ...
         2*L3*M4*MZ4*jac_hd3*cos(hd1 - hd2 - hd4) + 2*L3*M4*MZ4*jac_hd4* ...
        cos(hd1 - hd2 - hd4) + 2*L3*M4*MY4*jac_hd1*sin(hd1 - hd2 - hd4) - ...
         2*L3*M4*MY4*jac_hd2*sin(hd1 - hd2 - hd4) + 2*L3*M4*MY4*jac_hd3* ...
        sin(hd1 - hd2 - hd4) - 2*L3*M4*MY4*jac_hd4*sin(hd1 - hd2 - hd4) - ...
         2*L3*M1*MZ1*jac_hd1*cos(hd1) - 2*L3*M1*MZ1*jac_hd3*cos(hd1) + 4* ...
        L3*M4*MZ4*jac_hd1*cos(hd4) - 4*L3*M4*MZ4*jac_hd2*cos(hd4) + 2*L3* ...
        M4*MZ4*jac_hd3*cos(hd4) - 2*L3*M4*MZ4*jac_hd4*cos(hd4) + 2*L3*M1* ...
        MY1*jac_hd1*sin(hd1) + 2*L3*M1*MY1*jac_hd3*sin(hd1) + 4*L3*M4* ...
        MY4*jac_hd1*sin(hd4) - 4*L3*M4*MY4*jac_hd2*sin(hd4) + 2*L3*M4* ...
        MY4*jac_hd3*sin(hd4) - 2*L3*M4*MY4*jac_hd4*sin(hd4) - 2*L3*M3* ...
        MZ3*jac_hd1*cos(hd1 - hd2) + 2*L3*M3*MZ3*jac_hd2*cos(hd1 - hd2) - ...
         2*L3*M3*MZ3*jac_hd3*cos(hd1 - hd2) + 2*L3*M3*MY3*jac_hd1* ...
        sin(hd1 - hd2) - 2*L3*M3*MY3*jac_hd2*sin(hd1 - hd2) + 2*L3*M3* ...
        MY3*jac_hd3*sin(hd1 - hd2) - 2*L4*M4*MZ4*jac_hd1*cos(hd1 - hd2 + ...
         hd3 - hd4) + 2*L4*M4*MZ4*jac_hd2*cos(hd1 - hd2 + hd3 - hd4) + 2* ...
        L4*M4*MZ4*jac_hd4*cos(hd1 - hd2 + hd3 - hd4) + 2*L4*M4*MY4* ...
        jac_hd1*sin(hd1 - hd2 + hd3 - hd4) - 2*L4*M4*MY4*jac_hd2* ...
        sin(hd1 - hd2 + hd3 - hd4) - 2*L4*M4*MY4*jac_hd4*sin(hd1 - hd2 + ...
         hd3 - hd4));
dq(3) = -(2*jac_hd3*z2)/(2*XX1 + 4*XX3 + 4*XX4 + 2*XX1*jac_hd1 + XX1* ...
        jac_hd3 + 2*XX3*jac_hd1 - 2*XX3*jac_hd2 + 2*XX4*jac_hd1 + 2*XX3* ...
        jac_hd3 - 2*XX4*jac_hd2 - 2*XX4*jac_hd4 + 2*L3^2*M1 + 2*L4^2*M1 + ...
         4*L3^2*M3 + 4*L3^2*M4 + 4*L4^2*M3 + 4*L4^2*M4 + 2*M1*MY1^2 + 4* ...
        M3*MY3^2 + 4*M4*MY4^2 + 2*M1*MZ1^2 + 4*M3*MZ3^2 + 4*M4*MZ4^2 - 4* ...
        L3*M3*MZ3 - 4*L4*M4*MZ4 - 4*L3^2*M4*cos(hd1 - hd2) + L3^2*M1* ...
        jac_hd3 + 2*L3^2*M4*jac_hd1 - L4^2*M1*jac_hd3 + 2*L3^2*M3* ...
        jac_hd3 - 2*L3^2*M4*jac_hd2 + 2*L3^2*M4*jac_hd3 - 2*L4^2*M3* ...
        jac_hd3 - 2*L4^2*M4*jac_hd3 + 2*M1*MY1^2*jac_hd1 + M1*MY1^2* ...
        jac_hd3 + 2*M3*MY3^2*jac_hd1 - 2*M3*MY3^2*jac_hd2 + 2*M3*MY3^2* ...
        jac_hd3 + 2*M4*MY4^2*jac_hd1 - 2*M4*MY4^2*jac_hd2 - 2*M4*MY4^2* ...
        jac_hd4 + 2*M1*MZ1^2*jac_hd1 + M1*MZ1^2*jac_hd3 + 2*M3*MZ3^2* ...
        jac_hd1 - 2*M3*MZ3^2*jac_hd2 + 2*M3*MZ3^2*jac_hd3 + 2*M4*MZ4^2* ...
        jac_hd1 - 2*M4*MZ4^2*jac_hd2 - 2*M4*MZ4^2*jac_hd4 - 4*L3*M4*MZ4* ...
        cos(hd1 - hd2 - hd4) + 4*L3*L4*M1*cos(hd3) + 8*L3*L4*M3* ...
        cos(hd3) + 4*L3*L4*M4*cos(hd3) + 4*L3*M4*MY4*sin(hd1 - hd2 - ...
         hd4) - 4*L3*M1*MZ1*cos(hd1) - 4*L4*M3*MZ3*cos(hd3) + 4*L3*M4* ...
        MZ4*cos(hd4) + 4*L3*M1*MY1*sin(hd1) + 4*L4*M3*MY3*sin(hd3) + 4* ...
        L3*M4*MY4*sin(hd4) - 4*L3*M3*MZ3*cos(hd1 - hd2) + 4*L3*M3*MY3* ...
        sin(hd1 - hd2) - 4*L4*M4*MZ4*cos(hd1 - hd2 + hd3 - hd4) + 4*L4* ...
        M4*MY4*sin(hd1 - hd2 + hd3 - hd4) - 4*L3*L4*M4*cos(hd1 - hd2 + ...
         hd3) - 4*L4*M3*MZ3*cos(hd1 - hd2 + hd3) - 2*L3*M3*MZ3*jac_hd3 + ...
         2*L4*M4*MZ4*jac_hd3 + 4*L4*M3*MY3*sin(hd1 - hd2 + hd3) - 2*L3^2* ...
        M4*jac_hd1*cos(hd1 - hd2) + 2*L3^2*M4*jac_hd2*cos(hd1 - hd2) - 2* ...
        L3^2*M4*jac_hd3*cos(hd1 - hd2) - 4*L4*M1*MZ1*cos(hd1 + hd3) + 4* ...
        L4*M1*MY1*sin(hd1 + hd3) - 2*L3*L4*M4*jac_hd1*cos(hd1 - hd2 + ...
         hd3) + 2*L3*L4*M4*jac_hd2*cos(hd1 - hd2 + hd3) - 2*L4*M3*MZ3* ...
        jac_hd1*cos(hd1 - hd2 + hd3) + 2*L4*M3*MZ3*jac_hd2*cos(hd1 - ...
         hd2 + hd3) + 2*L4*M3*MY3*jac_hd1*sin(hd1 - hd2 + hd3) - 2*L4*M3* ...
        MY3*jac_hd2*sin(hd1 - hd2 + hd3) - 2*L4*M1*MZ1*jac_hd1*cos(hd1 + ...
         hd3) + 2*L4*M1*MY1*jac_hd1*sin(hd1 + hd3) - 2*L3*M4*MZ4*jac_hd1* ...
        cos(hd1 - hd2 - hd4) + 2*L3*M4*MZ4*jac_hd2*cos(hd1 - hd2 - hd4) - ...
         2*L3*M4*MZ4*jac_hd3*cos(hd1 - hd2 - hd4) + 2*L3*M4*MZ4*jac_hd4* ...
        cos(hd1 - hd2 - hd4) + 2*L3*M4*MY4*jac_hd1*sin(hd1 - hd2 - hd4) - ...
         2*L3*M4*MY4*jac_hd2*sin(hd1 - hd2 - hd4) + 2*L3*M4*MY4*jac_hd3* ...
        sin(hd1 - hd2 - hd4) - 2*L3*M4*MY4*jac_hd4*sin(hd1 - hd2 - hd4) - ...
         2*L3*M1*MZ1*jac_hd1*cos(hd1) - 2*L3*M1*MZ1*jac_hd3*cos(hd1) + 4* ...
        L3*M4*MZ4*jac_hd1*cos(hd4) - 4*L3*M4*MZ4*jac_hd2*cos(hd4) + 2*L3* ...
        M4*MZ4*jac_hd3*cos(hd4) - 2*L3*M4*MZ4*jac_hd4*cos(hd4) + 2*L3*M1* ...
        MY1*jac_hd1*sin(hd1) + 2*L3*M1*MY1*jac_hd3*sin(hd1) + 4*L3*M4* ...
        MY4*jac_hd1*sin(hd4) - 4*L3*M4*MY4*jac_hd2*sin(hd4) + 2*L3*M4* ...
        MY4*jac_hd3*sin(hd4) - 2*L3*M4*MY4*jac_hd4*sin(hd4) - 2*L3*M3* ...
        MZ3*jac_hd1*cos(hd1 - hd2) + 2*L3*M3*MZ3*jac_hd2*cos(hd1 - hd2) - ...
         2*L3*M3*MZ3*jac_hd3*cos(hd1 - hd2) + 2*L3*M3*MY3*jac_hd1* ...
        sin(hd1 - hd2) - 2*L3*M3*MY3*jac_hd2*sin(hd1 - hd2) + 2*L3*M3* ...
        MY3*jac_hd3*sin(hd1 - hd2) - 2*L4*M4*MZ4*jac_hd1*cos(hd1 - hd2 + ...
         hd3 - hd4) + 2*L4*M4*MZ4*jac_hd2*cos(hd1 - hd2 + hd3 - hd4) + 2* ...
        L4*M4*MZ4*jac_hd4*cos(hd1 - hd2 + hd3 - hd4) + 2*L4*M4*MY4* ...
        jac_hd1*sin(hd1 - hd2 + hd3 - hd4) - 2*L4*M4*MY4*jac_hd2* ...
        sin(hd1 - hd2 + hd3 - hd4) - 2*L4*M4*MY4*jac_hd4*sin(hd1 - hd2 + ...
         hd3 - hd4));
dq(4) = -(2*jac_hd4*z2)/(2*XX1 + 4*XX3 + 4*XX4 + 2*XX1*jac_hd1 + XX1* ...
        jac_hd3 + 2*XX3*jac_hd1 - 2*XX3*jac_hd2 + 2*XX4*jac_hd1 + 2*XX3* ...
        jac_hd3 - 2*XX4*jac_hd2 - 2*XX4*jac_hd4 + 2*L3^2*M1 + 2*L4^2*M1 + ...
         4*L3^2*M3 + 4*L3^2*M4 + 4*L4^2*M3 + 4*L4^2*M4 + 2*M1*MY1^2 + 4* ...
        M3*MY3^2 + 4*M4*MY4^2 + 2*M1*MZ1^2 + 4*M3*MZ3^2 + 4*M4*MZ4^2 - 4* ...
        L3*M3*MZ3 - 4*L4*M4*MZ4 - 4*L3^2*M4*cos(hd1 - hd2) + L3^2*M1* ...
        jac_hd3 + 2*L3^2*M4*jac_hd1 - L4^2*M1*jac_hd3 + 2*L3^2*M3* ...
        jac_hd3 - 2*L3^2*M4*jac_hd2 + 2*L3^2*M4*jac_hd3 - 2*L4^2*M3* ...
        jac_hd3 - 2*L4^2*M4*jac_hd3 + 2*M1*MY1^2*jac_hd1 + M1*MY1^2* ...
        jac_hd3 + 2*M3*MY3^2*jac_hd1 - 2*M3*MY3^2*jac_hd2 + 2*M3*MY3^2* ...
        jac_hd3 + 2*M4*MY4^2*jac_hd1 - 2*M4*MY4^2*jac_hd2 - 2*M4*MY4^2* ...
        jac_hd4 + 2*M1*MZ1^2*jac_hd1 + M1*MZ1^2*jac_hd3 + 2*M3*MZ3^2* ...
        jac_hd1 - 2*M3*MZ3^2*jac_hd2 + 2*M3*MZ3^2*jac_hd3 + 2*M4*MZ4^2* ...
        jac_hd1 - 2*M4*MZ4^2*jac_hd2 - 2*M4*MZ4^2*jac_hd4 - 4*L3*M4*MZ4* ...
        cos(hd1 - hd2 - hd4) + 4*L3*L4*M1*cos(hd3) + 8*L3*L4*M3* ...
        cos(hd3) + 4*L3*L4*M4*cos(hd3) + 4*L3*M4*MY4*sin(hd1 - hd2 - ...
         hd4) - 4*L3*M1*MZ1*cos(hd1) - 4*L4*M3*MZ3*cos(hd3) + 4*L3*M4* ...
        MZ4*cos(hd4) + 4*L3*M1*MY1*sin(hd1) + 4*L4*M3*MY3*sin(hd3) + 4* ...
        L3*M4*MY4*sin(hd4) - 4*L3*M3*MZ3*cos(hd1 - hd2) + 4*L3*M3*MY3* ...
        sin(hd1 - hd2) - 4*L4*M4*MZ4*cos(hd1 - hd2 + hd3 - hd4) + 4*L4* ...
        M4*MY4*sin(hd1 - hd2 + hd3 - hd4) - 4*L3*L4*M4*cos(hd1 - hd2 + ...
         hd3) - 4*L4*M3*MZ3*cos(hd1 - hd2 + hd3) - 2*L3*M3*MZ3*jac_hd3 + ...
         2*L4*M4*MZ4*jac_hd3 + 4*L4*M3*MY3*sin(hd1 - hd2 + hd3) - 2*L3^2* ...
        M4*jac_hd1*cos(hd1 - hd2) + 2*L3^2*M4*jac_hd2*cos(hd1 - hd2) - 2* ...
        L3^2*M4*jac_hd3*cos(hd1 - hd2) - 4*L4*M1*MZ1*cos(hd1 + hd3) + 4* ...
        L4*M1*MY1*sin(hd1 + hd3) - 2*L3*L4*M4*jac_hd1*cos(hd1 - hd2 + ...
         hd3) + 2*L3*L4*M4*jac_hd2*cos(hd1 - hd2 + hd3) - 2*L4*M3*MZ3* ...
        jac_hd1*cos(hd1 - hd2 + hd3) + 2*L4*M3*MZ3*jac_hd2*cos(hd1 - ...
         hd2 + hd3) + 2*L4*M3*MY3*jac_hd1*sin(hd1 - hd2 + hd3) - 2*L4*M3* ...
        MY3*jac_hd2*sin(hd1 - hd2 + hd3) - 2*L4*M1*MZ1*jac_hd1*cos(hd1 + ...
         hd3) + 2*L4*M1*MY1*jac_hd1*sin(hd1 + hd3) - 2*L3*M4*MZ4*jac_hd1* ...
        cos(hd1 - hd2 - hd4) + 2*L3*M4*MZ4*jac_hd2*cos(hd1 - hd2 - hd4) - ...
         2*L3*M4*MZ4*jac_hd3*cos(hd1 - hd2 - hd4) + 2*L3*M4*MZ4*jac_hd4* ...
        cos(hd1 - hd2 - hd4) + 2*L3*M4*MY4*jac_hd1*sin(hd1 - hd2 - hd4) - ...
         2*L3*M4*MY4*jac_hd2*sin(hd1 - hd2 - hd4) + 2*L3*M4*MY4*jac_hd3* ...
        sin(hd1 - hd2 - hd4) - 2*L3*M4*MY4*jac_hd4*sin(hd1 - hd2 - hd4) - ...
         2*L3*M1*MZ1*jac_hd1*cos(hd1) - 2*L3*M1*MZ1*jac_hd3*cos(hd1) + 4* ...
        L3*M4*MZ4*jac_hd1*cos(hd4) - 4*L3*M4*MZ4*jac_hd2*cos(hd4) + 2*L3* ...
        M4*MZ4*jac_hd3*cos(hd4) - 2*L3*M4*MZ4*jac_hd4*cos(hd4) + 2*L3*M1* ...
        MY1*jac_hd1*sin(hd1) + 2*L3*M1*MY1*jac_hd3*sin(hd1) + 4*L3*M4* ...
        MY4*jac_hd1*sin(hd4) - 4*L3*M4*MY4*jac_hd2*sin(hd4) + 2*L3*M4* ...
        MY4*jac_hd3*sin(hd4) - 2*L3*M4*MY4*jac_hd4*sin(hd4) - 2*L3*M3* ...
        MZ3*jac_hd1*cos(hd1 - hd2) + 2*L3*M3*MZ3*jac_hd2*cos(hd1 - hd2) - ...
         2*L3*M3*MZ3*jac_hd3*cos(hd1 - hd2) + 2*L3*M3*MY3*jac_hd1* ...
        sin(hd1 - hd2) - 2*L3*M3*MY3*jac_hd2*sin(hd1 - hd2) + 2*L3*M3* ...
        MY3*jac_hd3*sin(hd1 - hd2) - 2*L4*M4*MZ4*jac_hd1*cos(hd1 - hd2 + ...
         hd3 - hd4) + 2*L4*M4*MZ4*jac_hd2*cos(hd1 - hd2 + hd3 - hd4) + 2* ...
        L4*M4*MZ4*jac_hd4*cos(hd1 - hd2 + hd3 - hd4) + 2*L4*M4*MY4* ...
        jac_hd1*sin(hd1 - hd2 + hd3 - hd4) - 2*L4*M4*MY4*jac_hd2* ...
        sin(hd1 - hd2 + hd3 - hd4) - 2*L4*M4*MY4*jac_hd4*sin(hd1 - hd2 + ...
         hd3 - hd4));
dq(5) = (z2*(2*jac_hd1 + jac_hd3 + 2))/(2*XX1 + 4*XX3 + 4*XX4 + 2*XX1* ...
        jac_hd1 + XX1*jac_hd3 + 2*XX3*jac_hd1 - 2*XX3*jac_hd2 + 2*XX4* ...
        jac_hd1 + 2*XX3*jac_hd3 - 2*XX4*jac_hd2 - 2*XX4*jac_hd4 + 2*L3^2* ...
        M1 + 2*L4^2*M1 + 4*L3^2*M3 + 4*L3^2*M4 + 4*L4^2*M3 + 4*L4^2*M4 + ...
         2*M1*MY1^2 + 4*M3*MY3^2 + 4*M4*MY4^2 + 2*M1*MZ1^2 + 4*M3*MZ3^2 + ...
         4*M4*MZ4^2 - 4*L3*M3*MZ3 - 4*L4*M4*MZ4 - 4*L3^2*M4*cos(hd1 - ...
         hd2) + L3^2*M1*jac_hd3 + 2*L3^2*M4*jac_hd1 - L4^2*M1*jac_hd3 + ...
         2*L3^2*M3*jac_hd3 - 2*L3^2*M4*jac_hd2 + 2*L3^2*M4*jac_hd3 - 2* ...
        L4^2*M3*jac_hd3 - 2*L4^2*M4*jac_hd3 + 2*M1*MY1^2*jac_hd1 + M1* ...
        MY1^2*jac_hd3 + 2*M3*MY3^2*jac_hd1 - 2*M3*MY3^2*jac_hd2 + 2*M3* ...
        MY3^2*jac_hd3 + 2*M4*MY4^2*jac_hd1 - 2*M4*MY4^2*jac_hd2 - 2*M4* ...
        MY4^2*jac_hd4 + 2*M1*MZ1^2*jac_hd1 + M1*MZ1^2*jac_hd3 + 2*M3* ...
        MZ3^2*jac_hd1 - 2*M3*MZ3^2*jac_hd2 + 2*M3*MZ3^2*jac_hd3 + 2*M4* ...
        MZ4^2*jac_hd1 - 2*M4*MZ4^2*jac_hd2 - 2*M4*MZ4^2*jac_hd4 - 4*L3* ...
        M4*MZ4*cos(hd1 - hd2 - hd4) + 4*L3*L4*M1*cos(hd3) + 8*L3*L4*M3* ...
        cos(hd3) + 4*L3*L4*M4*cos(hd3) + 4*L3*M4*MY4*sin(hd1 - hd2 - ...
         hd4) - 4*L3*M1*MZ1*cos(hd1) - 4*L4*M3*MZ3*cos(hd3) + 4*L3*M4* ...
        MZ4*cos(hd4) + 4*L3*M1*MY1*sin(hd1) + 4*L4*M3*MY3*sin(hd3) + 4* ...
        L3*M4*MY4*sin(hd4) - 4*L3*M3*MZ3*cos(hd1 - hd2) + 4*L3*M3*MY3* ...
        sin(hd1 - hd2) - 4*L4*M4*MZ4*cos(hd1 - hd2 + hd3 - hd4) + 4*L4* ...
        M4*MY4*sin(hd1 - hd2 + hd3 - hd4) - 4*L3*L4*M4*cos(hd1 - hd2 + ...
         hd3) - 4*L4*M3*MZ3*cos(hd1 - hd2 + hd3) - 2*L3*M3*MZ3*jac_hd3 + ...
         2*L4*M4*MZ4*jac_hd3 + 4*L4*M3*MY3*sin(hd1 - hd2 + hd3) - 2*L3^2* ...
        M4*jac_hd1*cos(hd1 - hd2) + 2*L3^2*M4*jac_hd2*cos(hd1 - hd2) - 2* ...
        L3^2*M4*jac_hd3*cos(hd1 - hd2) - 4*L4*M1*MZ1*cos(hd1 + hd3) + 4* ...
        L4*M1*MY1*sin(hd1 + hd3) - 2*L3*L4*M4*jac_hd1*cos(hd1 - hd2 + ...
         hd3) + 2*L3*L4*M4*jac_hd2*cos(hd1 - hd2 + hd3) - 2*L4*M3*MZ3* ...
        jac_hd1*cos(hd1 - hd2 + hd3) + 2*L4*M3*MZ3*jac_hd2*cos(hd1 - ...
         hd2 + hd3) + 2*L4*M3*MY3*jac_hd1*sin(hd1 - hd2 + hd3) - 2*L4*M3* ...
        MY3*jac_hd2*sin(hd1 - hd2 + hd3) - 2*L4*M1*MZ1*jac_hd1*cos(hd1 + ...
         hd3) + 2*L4*M1*MY1*jac_hd1*sin(hd1 + hd3) - 2*L3*M4*MZ4*jac_hd1* ...
        cos(hd1 - hd2 - hd4) + 2*L3*M4*MZ4*jac_hd2*cos(hd1 - hd2 - hd4) - ...
         2*L3*M4*MZ4*jac_hd3*cos(hd1 - hd2 - hd4) + 2*L3*M4*MZ4*jac_hd4* ...
        cos(hd1 - hd2 - hd4) + 2*L3*M4*MY4*jac_hd1*sin(hd1 - hd2 - hd4) - ...
         2*L3*M4*MY4*jac_hd2*sin(hd1 - hd2 - hd4) + 2*L3*M4*MY4*jac_hd3* ...
        sin(hd1 - hd2 - hd4) - 2*L3*M4*MY4*jac_hd4*sin(hd1 - hd2 - hd4) - ...
         2*L3*M1*MZ1*jac_hd1*cos(hd1) - 2*L3*M1*MZ1*jac_hd3*cos(hd1) + 4* ...
        L3*M4*MZ4*jac_hd1*cos(hd4) - 4*L3*M4*MZ4*jac_hd2*cos(hd4) + 2*L3* ...
        M4*MZ4*jac_hd3*cos(hd4) - 2*L3*M4*MZ4*jac_hd4*cos(hd4) + 2*L3*M1* ...
        MY1*jac_hd1*sin(hd1) + 2*L3*M1*MY1*jac_hd3*sin(hd1) + 4*L3*M4* ...
        MY4*jac_hd1*sin(hd4) - 4*L3*M4*MY4*jac_hd2*sin(hd4) + 2*L3*M4* ...
        MY4*jac_hd3*sin(hd4) - 2*L3*M4*MY4*jac_hd4*sin(hd4) - 2*L3*M3* ...
        MZ3*jac_hd1*cos(hd1 - hd2) + 2*L3*M3*MZ3*jac_hd2*cos(hd1 - hd2) - ...
         2*L3*M3*MZ3*jac_hd3*cos(hd1 - hd2) + 2*L3*M3*MY3*jac_hd1* ...
        sin(hd1 - hd2) - 2*L3*M3*MY3*jac_hd2*sin(hd1 - hd2) + 2*L3*M3* ...
        MY3*jac_hd3*sin(hd1 - hd2) - 2*L4*M4*MZ4*jac_hd1*cos(hd1 - hd2 + ...
         hd3 - hd4) + 2*L4*M4*MZ4*jac_hd2*cos(hd1 - hd2 + hd3 - hd4) + 2* ...
        L4*M4*MZ4*jac_hd4*cos(hd1 - hd2 + hd3 - hd4) + 2*L4*M4*MY4* ...
        jac_hd1*sin(hd1 - hd2 + hd3 - hd4) - 2*L4*M4*MY4*jac_hd2* ...
        sin(hd1 - hd2 + hd3 - hd4) - 2*L4*M4*MY4*jac_hd4*sin(hd1 - hd2 + ...
         hd3 - hd4));

x0 = [q(1:5)'; dq(1:5)'];