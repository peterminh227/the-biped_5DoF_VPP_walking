function [D,C,G,B] = dyn_mod_5links_5DoF(q,dq)
% DYN_MOD_5LINKS_5DOF
%   [D,C,G,B] = DYN_MOD_5LINKS_5DOF(Q,DQ)  is the kneed biped walking model.

%Eric Westervelt
%2016 Version: Peter Minh
%05-Dec-2016 17:03:22

modelP;

q31L=q(1); q32L=q(2); q41L=q(3); q42L=q(4); q1L=q(5);
dq31L=dq(1); dq32L=dq(2); dq41L=dq(3); dq42L=dq(4); dq1L= dq(5);

% D matrix
D=zeros(5);
D(1,1)=XX3 + XX4 + L3^2*M1 + L4^2*M1 + 2*L3^2*M3 + L3^2*M4 + 2*L4^2*M3 + ...
        2*L4^2*M4 + M3*MY3^2 + M4*MY4^2 + M3*MZ3^2 + M4*MZ4^2 - 2*L3*M3* ...
       MZ3 - 2*L4*M4*MZ4 + 2*L3*L4*M1*cos(q41L) + 4*L3*L4*M3*cos(q41L) + ...
        2*L3*L4*M4*cos(q41L) - 2*L4*M3*MZ3*cos(q41L) + 2*L4*M3*MY3* ...
       sin(q41L);
D(1,2)=L3*M4*MY4*sin(q31L - q32L - q42L) - L3*M4*MZ4*cos(q31L - q32L - ...
        q42L) - L3^2*M4*cos(q31L - q32L) - L3*M3*MZ3*cos(q31L - q32L) + ...
        L3*M3*MY3*sin(q31L - q32L) - L4*M4*MZ4*cos(q31L - q32L + q41L - ...
        q42L) + L4*M4*MY4*sin(q31L - q32L + q41L - q42L) - L3*L4*M4* ...
       cos(q31L - q32L + q41L) - L4*M3*MZ3*cos(q31L - q32L + q41L) + L4* ...
       M3*MY3*sin(q31L - q32L + q41L);
D(1,3)=XX4 + L4^2*M1 + 2*L4^2*M3 + 2*L4^2*M4 + M4*MY4^2 + M4*MZ4^2 - 2* ...
       L4*M4*MZ4 + L3*L4*M1*cos(q41L) + 2*L3*L4*M3*cos(q41L) + L3*L4*M4* ...
       cos(q41L) - L4*M3*MZ3*cos(q41L) + L4*M3*MY3*sin(q41L);
D(1,4)=L3*M4*MY4*sin(q31L - q32L - q42L) - L3*M4*MZ4*cos(q31L - q32L - ...
        q42L) - L4*M4*MZ4*cos(q31L - q32L + q41L - q42L) + L4*M4*MY4* ...
       sin(q31L - q32L + q41L - q42L);
D(1,5)=XX3 + XX4 + L3^2*M1 + L4^2*M1 + 2*L3^2*M3 + L3^2*M4 + 2*L4^2*M3 + ...
        2*L4^2*M4 + M3*MY3^2 + M4*MY4^2 + M3*MZ3^2 + M4*MZ4^2 - 2*L3*M3* ...
       MZ3 - 2*L4*M4*MZ4 - L3^2*M4*cos(q31L - q32L) + 2*L3*L4*M1* ...
       cos(q41L) + 4*L3*L4*M3*cos(q41L) + 2*L3*L4*M4*cos(q41L) - L3*M1* ...
       MZ1*cos(q31L) - 2*L4*M3*MZ3*cos(q41L) - L3*M4*MZ4*cos(q31L - ...
        q32L - q42L) + L3*M1*MY1*sin(q31L) + 2*L4*M3*MY3*sin(q41L) + L3* ...
       M4*MY4*sin(q31L - q32L - q42L) - L3*M3*MZ3*cos(q31L - q32L) + L3* ...
       M3*MY3*sin(q31L - q32L) - L4*M4*MZ4*cos(q31L - q32L + q41L - ...
        q42L) + L4*M4*MY4*sin(q31L - q32L + q41L - q42L) - L3*L4*M4* ...
       cos(q31L - q32L + q41L) - L4*M3*MZ3*cos(q31L - q32L + q41L) + L4* ...
       M3*MY3*sin(q31L - q32L + q41L) - L4*M1*MZ1*cos(q31L + q41L) + L4* ...
       M1*MY1*sin(q31L + q41L);
D(2,1)=L3*M4*MY4*sin(q31L - q32L - q42L) - L3*M4*MZ4*cos(q31L - q32L - ...
        q42L) - L3^2*M4*cos(q31L - q32L) - L3*M3*MZ3*cos(q31L - q32L) + ...
        L3*M3*MY3*sin(q31L - q32L) - L4*M4*MZ4*cos(q31L - q32L + q41L - ...
        q42L) + L4*M4*MY4*sin(q31L - q32L + q41L - q42L) - L3*L4*M4* ...
       cos(q31L - q32L + q41L) - L4*M3*MZ3*cos(q31L - q32L + q41L) + L4* ...
       M3*MY3*sin(q31L - q32L + q41L);
D(2,2)=XX3 + XX4 + L3^2*M4 + M3*MY3^2 + M4*MY4^2 + M3*MZ3^2 + M4*MZ4^2 + ...
        2*L3*M4*MZ4*cos(q42L) + 2*L3*M4*MY4*sin(q42L);
D(2,3)=L4*M4*MY4*sin(q31L - q32L + q41L - q42L) - L4*M4*MZ4*cos(q31L - ...
        q32L + q41L - q42L) - L3*L4*M4*cos(q31L - q32L + q41L) - L4*M3* ...
       MZ3*cos(q31L - q32L + q41L) + L4*M3*MY3*sin(q31L - q32L + q41L);
D(2,4)=XX4 + M4*MY4^2 + M4*MZ4^2 + L3*M4*MZ4*cos(q42L) + L3*M4*MY4* ...
       sin(q42L);
D(2,5)=XX3 + XX4 + L3^2*M4 + M3*MY3^2 + M4*MY4^2 + M3*MZ3^2 + M4*MZ4^2 - ...
        L3^2*M4*cos(q31L - q32L) + 2*L3*M4*MZ4*cos(q42L) - L3*M4*MZ4* ...
       cos(q31L - q32L - q42L) + 2*L3*M4*MY4*sin(q42L) + L3*M4*MY4* ...
       sin(q31L - q32L - q42L) - L3*M3*MZ3*cos(q31L - q32L) + L3*M3*MY3* ...
       sin(q31L - q32L) - L4*M4*MZ4*cos(q31L - q32L + q41L - q42L) + L4* ...
       M4*MY4*sin(q31L - q32L + q41L - q42L) - L3*L4*M4*cos(q31L - ...
        q32L + q41L) - L4*M3*MZ3*cos(q31L - q32L + q41L) + L4*M3*MY3* ...
       sin(q31L - q32L + q41L);
D(3,1)=XX4 + L4^2*M1 + 2*L4^2*M3 + 2*L4^2*M4 + M4*MY4^2 + M4*MZ4^2 - 2* ...
       L4*M4*MZ4 + L3*L4*M1*cos(q41L) + 2*L3*L4*M3*cos(q41L) + L3*L4*M4* ...
       cos(q41L) - L4*M3*MZ3*cos(q41L) + L4*M3*MY3*sin(q41L);
D(3,2)=L4*M4*MY4*sin(q31L - q32L + q41L - q42L) - L4*M4*MZ4*cos(q31L - ...
        q32L + q41L - q42L) - L3*L4*M4*cos(q31L - q32L + q41L) - L4*M3* ...
       MZ3*cos(q31L - q32L + q41L) + L4*M3*MY3*sin(q31L - q32L + q41L);
D(3,3)=XX4 + L4^2*M1 + 2*L4^2*M3 + 2*L4^2*M4 + M4*MY4^2 + M4*MZ4^2 - 2* ...
       L4*M4*MZ4;
D(3,4)=L4*M4*MY4*sin(q31L - q32L + q41L - q42L) - L4*M4*MZ4*cos(q31L - ...
        q32L + q41L - q42L);
D(3,5)=XX4 + L4^2*M1 + 2*L4^2*M3 + 2*L4^2*M4 + M4*MY4^2 + M4*MZ4^2 - 2* ...
       L4*M4*MZ4 + L3*L4*M1*cos(q41L) + 2*L3*L4*M3*cos(q41L) + L3*L4*M4* ...
       cos(q41L) - L4*M3*MZ3*cos(q41L) + L4*M3*MY3*sin(q41L) - L4*M4* ...
       MZ4*cos(q31L - q32L + q41L - q42L) + L4*M4*MY4*sin(q31L - q32L + ...
        q41L - q42L) - L3*L4*M4*cos(q31L - q32L + q41L) - L4*M3*MZ3* ...
       cos(q31L - q32L + q41L) + L4*M3*MY3*sin(q31L - q32L + q41L) - L4* ...
       M1*MZ1*cos(q31L + q41L) + L4*M1*MY1*sin(q31L + q41L);
D(4,1)=L3*M4*MY4*sin(q31L - q32L - q42L) - L3*M4*MZ4*cos(q31L - q32L - ...
        q42L) - L4*M4*MZ4*cos(q31L - q32L + q41L - q42L) + L4*M4*MY4* ...
       sin(q31L - q32L + q41L - q42L);
D(4,2)=XX4 + M4*MY4^2 + M4*MZ4^2 + L3*M4*MZ4*cos(q42L) + L3*M4*MY4* ...
       sin(q42L);
D(4,3)=L4*M4*MY4*sin(q31L - q32L + q41L - q42L) - L4*M4*MZ4*cos(q31L - ...
        q32L + q41L - q42L);
D(4,4)=XX4 + M4*MY4^2 + M4*MZ4^2;
D(4,5)=XX4 + M4*MY4^2 + M4*MZ4^2 + L3*M4*MZ4*cos(q42L) - L3*M4*MZ4* ...
       cos(q31L - q32L - q42L) + L3*M4*MY4*sin(q42L) + L3*M4*MY4* ...
       sin(q31L - q32L - q42L) - L4*M4*MZ4*cos(q31L - q32L + q41L - ...
        q42L) + L4*M4*MY4*sin(q31L - q32L + q41L - q42L);
D(5,1)=XX3 + XX4 + L3^2*M1 + L4^2*M1 + 2*L3^2*M3 + L3^2*M4 + 2*L4^2*M3 + ...
        2*L4^2*M4 + M3*MY3^2 + M4*MY4^2 + M3*MZ3^2 + M4*MZ4^2 - 2*L3*M3* ...
       MZ3 - 2*L4*M4*MZ4 - L3^2*M4*cos(q31L - q32L) + 2*L3*L4*M1* ...
       cos(q41L) + 4*L3*L4*M3*cos(q41L) + 2*L3*L4*M4*cos(q41L) - L3*M1* ...
       MZ1*cos(q31L) - 2*L4*M3*MZ3*cos(q41L) - L3*M4*MZ4*cos(q31L - ...
        q32L - q42L) + L3*M1*MY1*sin(q31L) + 2*L4*M3*MY3*sin(q41L) + L3* ...
       M4*MY4*sin(q31L - q32L - q42L) - L3*M3*MZ3*cos(q31L - q32L) + L3* ...
       M3*MY3*sin(q31L - q32L) - L4*M4*MZ4*cos(q31L - q32L + q41L - ...
        q42L) + L4*M4*MY4*sin(q31L - q32L + q41L - q42L) - L3*L4*M4* ...
       cos(q31L - q32L + q41L) - L4*M3*MZ3*cos(q31L - q32L + q41L) + L4* ...
       M3*MY3*sin(q31L - q32L + q41L) - L4*M1*MZ1*cos(q31L + q41L) + L4* ...
       M1*MY1*sin(q31L + q41L);
D(5,2)=XX3 + XX4 + L3^2*M4 + M3*MY3^2 + M4*MY4^2 + M3*MZ3^2 + M4*MZ4^2 - ...
        L3^2*M4*cos(q31L - q32L) + 2*L3*M4*MZ4*cos(q42L) - L3*M4*MZ4* ...
       cos(q31L - q32L - q42L) + 2*L3*M4*MY4*sin(q42L) + L3*M4*MY4* ...
       sin(q31L - q32L - q42L) - L3*M3*MZ3*cos(q31L - q32L) + L3*M3*MY3* ...
       sin(q31L - q32L) - L4*M4*MZ4*cos(q31L - q32L + q41L - q42L) + L4* ...
       M4*MY4*sin(q31L - q32L + q41L - q42L) - L3*L4*M4*cos(q31L - ...
        q32L + q41L) - L4*M3*MZ3*cos(q31L - q32L + q41L) + L4*M3*MY3* ...
       sin(q31L - q32L + q41L);
D(5,3)=XX4 + L4^2*M1 + 2*L4^2*M3 + 2*L4^2*M4 + M4*MY4^2 + M4*MZ4^2 - 2* ...
       L4*M4*MZ4 + L3*L4*M1*cos(q41L) + 2*L3*L4*M3*cos(q41L) + L3*L4*M4* ...
       cos(q41L) - L4*M3*MZ3*cos(q41L) + L4*M3*MY3*sin(q41L) - L4*M4* ...
       MZ4*cos(q31L - q32L + q41L - q42L) + L4*M4*MY4*sin(q31L - q32L + ...
        q41L - q42L) - L3*L4*M4*cos(q31L - q32L + q41L) - L4*M3*MZ3* ...
       cos(q31L - q32L + q41L) + L4*M3*MY3*sin(q31L - q32L + q41L) - L4* ...
       M1*MZ1*cos(q31L + q41L) + L4*M1*MY1*sin(q31L + q41L);
D(5,4)=XX4 + M4*MY4^2 + M4*MZ4^2 + L3*M4*MZ4*cos(q42L) - L3*M4*MZ4* ...
       cos(q31L - q32L - q42L) + L3*M4*MY4*sin(q42L) + L3*M4*MY4* ...
       sin(q31L - q32L - q42L) - L4*M4*MZ4*cos(q31L - q32L + q41L - ...
        q42L) + L4*M4*MY4*sin(q31L - q32L + q41L - q42L);
D(5,5)=XX1 + 2*XX3 + 2*XX4 + L3^2*M1 + L4^2*M1 + 2*L3^2*M3 + 2*L3^2*M4 + ...
        2*L4^2*M3 + 2*L4^2*M4 + M1*MY1^2 + 2*M3*MY3^2 + 2*M4*MY4^2 + M1* ...
       MZ1^2 + 2*M3*MZ3^2 + 2*M4*MZ4^2 - 2*L3*M3*MZ3 - 2*L4*M4*MZ4 - 2* ...
       L3^2*M4*cos(q31L - q32L) + 2*L3*L4*M1*cos(q41L) + 4*L3*L4*M3* ...
       cos(q41L) + 2*L3*L4*M4*cos(q41L) - 2*L3*M1*MZ1*cos(q31L) - 2*L4* ...
       M3*MZ3*cos(q41L) + 2*L3*M4*MZ4*cos(q42L) - 2*L3*M4*MZ4*cos(q31L - ...
        q32L - q42L) + 2*L3*M1*MY1*sin(q31L) + 2*L4*M3*MY3*sin(q41L) + ...
        2*L3*M4*MY4*sin(q42L) + 2*L3*M4*MY4*sin(q31L - q32L - q42L) - 2* ...
       L3*M3*MZ3*cos(q31L - q32L) + 2*L3*M3*MY3*sin(q31L - q32L) - 2*L4* ...
       M4*MZ4*cos(q31L - q32L + q41L - q42L) + 2*L4*M4*MY4*sin(q31L - ...
        q32L + q41L - q42L) - 2*L3*L4*M4*cos(q31L - q32L + q41L) - 2*L4* ...
       M3*MZ3*cos(q31L - q32L + q41L) + 2*L4*M3*MY3*sin(q31L - q32L + ...
        q41L) - 2*L4*M1*MZ1*cos(q31L + q41L) + 2*L4*M1*MY1*sin(q31L + ...
        q41L);

% C matrix
C=zeros(5);
C(1,1)=-L4*dq41L*(L3*M1*sin(q41L) - M3*MY3*cos(q41L) + 2*L3*M3* ...
       sin(q41L) + L3*M4*sin(q41L) - M3*MZ3*sin(q41L));
C(1,2)=- dq42L*(L3*M4*MY4*cos(q31L - q32L - q42L) + L3*M4*MZ4*sin(q31L - ...
        q32L - q42L) + L4*M4*MY4*cos(q31L - q32L + q41L - q42L) + L4*M4* ...
       MZ4*sin(q31L - q32L + q41L - q42L)) - dq1L*(L3^2*M4*sin(q31L - ...
        q32L) + L3*M4*MY4*cos(q31L - q32L - q42L) + L3*M4*MZ4*sin(q31L - ...
        q32L - q42L) + L3*M3*MY3*cos(q31L - q32L) + L3*M3*MZ3*sin(q31L - ...
        q32L) + L4*M4*MY4*cos(q31L - q32L + q41L - q42L) + L4*M4*MZ4* ...
       sin(q31L - q32L + q41L - q42L) + L4*M3*MY3*cos(q31L - q32L + ...
        q41L) + L3*L4*M4*sin(q31L - q32L + q41L) + L4*M3*MZ3*sin(q31L - ...
        q32L + q41L)) - dq32L*(L3^2*M4*sin(q31L - q32L) + L3*M4*MY4* ...
       cos(q31L - q32L - q42L) + L3*M4*MZ4*sin(q31L - q32L - q42L) + L3* ...
       M3*MY3*cos(q31L - q32L) + L3*M3*MZ3*sin(q31L - q32L) + L4*M4*MY4* ...
       cos(q31L - q32L + q41L - q42L) + L4*M4*MZ4*sin(q31L - q32L + ...
        q41L - q42L) + L4*M3*MY3*cos(q31L - q32L + q41L) + L3*L4*M4* ...
       sin(q31L - q32L + q41L) + L4*M3*MZ3*sin(q31L - q32L + q41L));
C(1,3)=-L4*(dq1L + dq31L + dq41L)*(L3*M1*sin(q41L) - M3*MY3*cos(q41L) + ...
        2*L3*M3*sin(q41L) + L3*M4*sin(q41L) - M3*MZ3*sin(q41L));
C(1,4)=-M4*(dq1L + dq32L + dq42L)*(L4*MY4*cos(q31L - q32L + q41L - ...
        q42L) + L4*MZ4*sin(q31L - q32L + q41L - q42L) + L3*MY4* ...
       cos(q31L - q32L - q42L) + L3*MZ4*sin(q31L - q32L - q42L));
C(1,5)=L4*M3*MY3*dq41L*cos(q41L) - L3^2*M4*dq32L*sin(q31L - q32L) - L4* ...
       M3*MY3*dq1L*cos(q31L - q32L + q41L) - L4*M3*MY3*dq32L*cos(q31L - ...
        q32L + q41L) - L3*L4*M4*dq1L*sin(q31L - q32L + q41L) - L3*L4*M4* ...
       dq32L*sin(q31L - q32L + q41L) - L4*M3*MZ3*dq1L*sin(q31L - q32L + ...
        q41L) - L4*M3*MZ3*dq32L*sin(q31L - q32L + q41L) - L4*M1*MY1* ...
       dq1L*cos(q31L + q41L) - L4*M1*MZ1*dq1L*sin(q31L + q41L) - L3*M1* ...
       MY1*dq1L*cos(q31L) - L3^2*M4*dq1L*sin(q31L - q32L) - L3*M4*MY4* ...
       dq1L*cos(q31L - q32L - q42L) - L3*M4*MY4*dq32L*cos(q31L - q32L - ...
        q42L) - L3*M4*MY4*dq42L*cos(q31L - q32L - q42L) - L3*L4*M1* ...
       dq41L*sin(q41L) - 2*L3*L4*M3*dq41L*sin(q41L) - L3*L4*M4*dq41L* ...
       sin(q41L) - L3*M1*MZ1*dq1L*sin(q31L) + L4*M3*MZ3*dq41L* ...
       sin(q41L) - L3*M4*MZ4*dq1L*sin(q31L - q32L - q42L) - L3*M4*MZ4* ...
       dq32L*sin(q31L - q32L - q42L) - L3*M4*MZ4*dq42L*sin(q31L - q32L - ...
        q42L) - L3*M3*MY3*dq1L*cos(q31L - q32L) - L3*M3*MY3*dq32L* ...
       cos(q31L - q32L) - L3*M3*MZ3*dq1L*sin(q31L - q32L) - L3*M3*MZ3* ...
       dq32L*sin(q31L - q32L) - L4*M4*MY4*dq1L*cos(q31L - q32L + q41L - ...
        q42L) - L4*M4*MY4*dq32L*cos(q31L - q32L + q41L - q42L) - L4*M4* ...
       MY4*dq42L*cos(q31L - q32L + q41L - q42L) - L4*M4*MZ4*dq1L* ...
       sin(q31L - q32L + q41L - q42L) - L4*M4*MZ4*dq32L*sin(q31L - ...
        q32L + q41L - q42L) - L4*M4*MZ4*dq42L*sin(q31L - q32L + q41L - ...
        q42L);
C(2,1)=dq41L*(L4*M4*MY4*cos(q31L - q32L + q41L - q42L) + L4*M4*MZ4* ...
       sin(q31L - q32L + q41L - q42L) + L4*M3*MY3*cos(q31L - q32L + ...
        q41L) + L3*L4*M4*sin(q31L - q32L + q41L) + L4*M3*MZ3*sin(q31L - ...
        q32L + q41L)) + dq1L*(L3^2*M4*sin(q31L - q32L) + L3*M4*MY4* ...
       cos(q31L - q32L - q42L) + L3*M4*MZ4*sin(q31L - q32L - q42L) + L3* ...
       M3*MY3*cos(q31L - q32L) + L3*M3*MZ3*sin(q31L - q32L) + L4*M4*MY4* ...
       cos(q31L - q32L + q41L - q42L) + L4*M4*MZ4*sin(q31L - q32L + ...
        q41L - q42L) + L4*M3*MY3*cos(q31L - q32L + q41L) + L3*L4*M4* ...
       sin(q31L - q32L + q41L) + L4*M3*MZ3*sin(q31L - q32L + q41L)) + ...
        dq31L*(L3^2*M4*sin(q31L - q32L) + L3*M4*MY4*cos(q31L - q32L - ...
        q42L) + L3*M4*MZ4*sin(q31L - q32L - q42L) + L3*M3*MY3*cos(q31L - ...
        q32L) + L3*M3*MZ3*sin(q31L - q32L) + L4*M4*MY4*cos(q31L - q32L + ...
        q41L - q42L) + L4*M4*MZ4*sin(q31L - q32L + q41L - q42L) + L4*M3* ...
       MY3*cos(q31L - q32L + q41L) + L3*L4*M4*sin(q31L - q32L + q41L) + ...
        L4*M3*MZ3*sin(q31L - q32L + q41L));
C(2,2)=L3*M4*dq42L*(MY4*cos(q42L) - MZ4*sin(q42L));
C(2,3)=L4*(dq1L + dq31L + dq41L)*(M4*MY4*cos(q31L - q32L + q41L - ...
        q42L) + M4*MZ4*sin(q31L - q32L + q41L - q42L) + M3*MY3* ...
       cos(q31L - q32L + q41L) + L3*M4*sin(q31L - q32L + q41L) + M3*MZ3* ...
       sin(q31L - q32L + q41L));
C(2,4)=L3*M4*(MY4*cos(q42L) - MZ4*sin(q42L))*(dq1L + dq32L + dq42L);
C(2,5)=L3^2*M4*dq1L*sin(q31L - q32L) + L3^2*M4*dq31L*sin(q31L - q32L) + ...
        L4*M3*MY3*dq1L*cos(q31L - q32L + q41L) + L4*M3*MY3*dq31L* ...
       cos(q31L - q32L + q41L) + L4*M3*MY3*dq41L*cos(q31L - q32L + ...
        q41L) + L3*L4*M4*dq1L*sin(q31L - q32L + q41L) + L3*L4*M4*dq31L* ...
       sin(q31L - q32L + q41L) + L3*L4*M4*dq41L*sin(q31L - q32L + ...
        q41L) + L4*M3*MZ3*dq1L*sin(q31L - q32L + q41L) + L4*M3*MZ3* ...
       dq31L*sin(q31L - q32L + q41L) + L4*M3*MZ3*dq41L*sin(q31L - q32L + ...
        q41L) + L3*M4*MY4*dq42L*cos(q42L) + L3*M4*MY4*dq1L*cos(q31L - ...
        q32L - q42L) + L3*M4*MY4*dq31L*cos(q31L - q32L - q42L) - L3*M4* ...
       MZ4*dq42L*sin(q42L) + L3*M4*MZ4*dq1L*sin(q31L - q32L - q42L) + ...
        L3*M4*MZ4*dq31L*sin(q31L - q32L - q42L) + L3*M3*MY3*dq1L* ...
       cos(q31L - q32L) + L3*M3*MY3*dq31L*cos(q31L - q32L) + L3*M3*MZ3* ...
       dq1L*sin(q31L - q32L) + L3*M3*MZ3*dq31L*sin(q31L - q32L) + L4*M4* ...
       MY4*dq1L*cos(q31L - q32L + q41L - q42L) + L4*M4*MY4*dq31L* ...
       cos(q31L - q32L + q41L - q42L) + L4*M4*MY4*dq41L*cos(q31L - ...
        q32L + q41L - q42L) + L4*M4*MZ4*dq1L*sin(q31L - q32L + q41L - ...
        q42L) + L4*M4*MZ4*dq31L*sin(q31L - q32L + q41L - q42L) + L4*M4* ...
       MZ4*dq41L*sin(q31L - q32L + q41L - q42L);
C(3,1)=L4*(dq1L + dq31L)*(L3*M1*sin(q41L) - M3*MY3*cos(q41L) + 2*L3*M3* ...
       sin(q41L) + L3*M4*sin(q41L) - M3*MZ3*sin(q41L));
C(3,2)=- L4*dq1L*(M4*MY4*cos(q31L - q32L + q41L - q42L) + M4*MZ4* ...
       sin(q31L - q32L + q41L - q42L) + M3*MY3*cos(q31L - q32L + q41L) + ...
        L3*M4*sin(q31L - q32L + q41L) + M3*MZ3*sin(q31L - q32L + ...
        q41L)) - L4*dq32L*(M4*MY4*cos(q31L - q32L + q41L - q42L) + M4* ...
       MZ4*sin(q31L - q32L + q41L - q42L) + M3*MY3*cos(q31L - q32L + ...
        q41L) + L3*M4*sin(q31L - q32L + q41L) + M3*MZ3*sin(q31L - q32L + ...
        q41L)) - L4*M4*dq42L*(MZ4*sin(q31L - q32L + q41L - q42L) + MY4* ...
       cos(q31L - q32L + q41L - q42L));
C(3,4)=-L4*M4*(MZ4*sin(q31L - q32L + q41L - q42L) + MY4*cos(q31L - ...
        q32L + q41L - q42L))*(dq1L + dq32L + dq42L);
C(3,5)=L3*L4*M1*dq1L*sin(q41L) - L4*M3*MY3*dq32L*cos(q31L - q32L + ...
        q41L) - L3*L4*M4*dq1L*sin(q31L - q32L + q41L) - L3*L4*M4*dq32L* ...
       sin(q31L - q32L + q41L) - L4*M3*MZ3*dq1L*sin(q31L - q32L + ...
        q41L) - L4*M3*MZ3*dq32L*sin(q31L - q32L + q41L) - L4*M1*MY1* ...
       dq1L*cos(q31L + q41L) - L4*M1*MZ1*dq1L*sin(q31L + q41L) - L4*M3* ...
       MY3*dq1L*cos(q41L) - L4*M3*MY3*dq31L*cos(q41L) - L4*M3*MY3*dq1L* ...
       cos(q31L - q32L + q41L) + 2*L3*L4*M3*dq1L*sin(q41L) + L3*L4*M4* ...
       dq1L*sin(q41L) + L3*L4*M1*dq31L*sin(q41L) + 2*L3*L4*M3*dq31L* ...
       sin(q41L) + L3*L4*M4*dq31L*sin(q41L) - L4*M3*MZ3*dq1L*sin(q41L) - ...
        L4*M3*MZ3*dq31L*sin(q41L) - L4*M4*MY4*dq1L*cos(q31L - q32L + ...
        q41L - q42L) - L4*M4*MY4*dq32L*cos(q31L - q32L + q41L - q42L) - ...
        L4*M4*MY4*dq42L*cos(q31L - q32L + q41L - q42L) - L4*M4*MZ4*dq1L* ...
       sin(q31L - q32L + q41L - q42L) - L4*M4*MZ4*dq32L*sin(q31L - ...
        q32L + q41L - q42L) - L4*M4*MZ4*dq42L*sin(q31L - q32L + q41L - ...
        q42L);
C(4,1)=M4*dq1L*(L4*MY4*cos(q31L - q32L + q41L - q42L) + L4*MZ4* ...
       sin(q31L - q32L + q41L - q42L) + L3*MY4*cos(q31L - q32L - q42L) + ...
        L3*MZ4*sin(q31L - q32L - q42L)) + M4*dq31L*(L4*MY4*cos(q31L - ...
        q32L + q41L - q42L) + L4*MZ4*sin(q31L - q32L + q41L - q42L) + ...
        L3*MY4*cos(q31L - q32L - q42L) + L3*MZ4*sin(q31L - q32L - ...
        q42L)) + L4*M4*dq41L*(MZ4*sin(q31L - q32L + q41L - q42L) + MY4* ...
       cos(q31L - q32L + q41L - q42L));
C(4,2)=-L3*M4*(dq1L + dq32L)*(MY4*cos(q42L) - MZ4*sin(q42L));
C(4,3)=L4*M4*(MZ4*sin(q31L - q32L + q41L - q42L) + MY4*cos(q31L - q32L + ...
        q41L - q42L))*(dq1L + dq31L + dq41L);
C(4,5)=dq41L*(L4*M4*MY4*cos(q31L - q32L + q41L - q42L) + L4*M4*MZ4* ...
       sin(q31L - q32L + q41L - q42L)) - dq32L*(L3*M4*MY4*cos(q42L) - ...
        L3*M4*MZ4*sin(q42L)) + dq31L*(L3*M4*MY4*cos(q31L - q32L - ...
        q42L) + L3*M4*MZ4*sin(q31L - q32L - q42L) + L4*M4*MY4*cos(q31L - ...
        q32L + q41L - q42L) + L4*M4*MZ4*sin(q31L - q32L + q41L - ...
        q42L)) + dq1L*(L3*M4*MY4*cos(q31L - q32L - q42L) - L3*M4*MY4* ...
       cos(q42L) + L3*M4*MZ4*sin(q42L) + L3*M4*MZ4*sin(q31L - q32L - ...
        q42L) + L4*M4*MY4*cos(q31L - q32L + q41L - q42L) + L4*M4*MZ4* ...
       sin(q31L - q32L + q41L - q42L));
C(5,1)=L3^2*M4*dq1L*sin(q31L - q32L) + L3^2*M4*dq31L*sin(q31L - q32L) + ...
        L4*M3*MY3*dq1L*cos(q31L - q32L + q41L) + L4*M3*MY3*dq31L* ...
       cos(q31L - q32L + q41L) + L4*M3*MY3*dq41L*cos(q31L - q32L + ...
        q41L) + L3*L4*M4*dq1L*sin(q31L - q32L + q41L) + L3*L4*M4*dq31L* ...
       sin(q31L - q32L + q41L) + L3*L4*M4*dq41L*sin(q31L - q32L + ...
        q41L) + L4*M3*MZ3*dq1L*sin(q31L - q32L + q41L) + L4*M3*MZ3* ...
       dq31L*sin(q31L - q32L + q41L) + L4*M3*MZ3*dq41L*sin(q31L - q32L + ...
        q41L) + L4*M1*MY1*dq1L*cos(q31L + q41L) + L4*M1*MY1*dq31L* ...
       cos(q31L + q41L) + L4*M1*MY1*dq41L*cos(q31L + q41L) + L4*M1*MZ1* ...
       dq1L*sin(q31L + q41L) + L4*M1*MZ1*dq31L*sin(q31L + q41L) + L4*M1* ...
       MZ1*dq41L*sin(q31L + q41L) + L3*M1*MY1*dq1L*cos(q31L) + L3*M1* ...
       MY1*dq31L*cos(q31L) + L4*M3*MY3*dq41L*cos(q41L) + L3*M4*MY4*dq1L* ...
       cos(q31L - q32L - q42L) + L3*M4*MY4*dq31L*cos(q31L - q32L - ...
        q42L) - L3*L4*M1*dq41L*sin(q41L) - 2*L3*L4*M3*dq41L*sin(q41L) - ...
        L3*L4*M4*dq41L*sin(q41L) + L3*M1*MZ1*dq1L*sin(q31L) + L3*M1*MZ1* ...
       dq31L*sin(q31L) + L4*M3*MZ3*dq41L*sin(q41L) + L3*M4*MZ4*dq1L* ...
       sin(q31L - q32L - q42L) + L3*M4*MZ4*dq31L*sin(q31L - q32L - ...
        q42L) + L3*M3*MY3*dq1L*cos(q31L - q32L) + L3*M3*MY3*dq31L* ...
       cos(q31L - q32L) + L3*M3*MZ3*dq1L*sin(q31L - q32L) + L3*M3*MZ3* ...
       dq31L*sin(q31L - q32L) + L4*M4*MY4*dq1L*cos(q31L - q32L + q41L - ...
        q42L) + L4*M4*MY4*dq31L*cos(q31L - q32L + q41L - q42L) + L4*M4* ...
       MY4*dq41L*cos(q31L - q32L + q41L - q42L) + L4*M4*MZ4*dq1L* ...
       sin(q31L - q32L + q41L - q42L) + L4*M4*MZ4*dq31L*sin(q31L - ...
        q32L + q41L - q42L) + L4*M4*MZ4*dq41L*sin(q31L - q32L + q41L - ...
        q42L);
C(5,2)=- dq42L*(L3*M4*MY4*cos(q31L - q32L - q42L) - L3*M4*MY4* ...
       cos(q42L) + L3*M4*MZ4*sin(q42L) + L3*M4*MZ4*sin(q31L - q32L - ...
        q42L) + L4*M4*MY4*cos(q31L - q32L + q41L - q42L) + L4*M4*MZ4* ...
       sin(q31L - q32L + q41L - q42L)) - dq1L*(L3^2*M4*sin(q31L - ...
        q32L) + L3*M4*MY4*cos(q31L - q32L - q42L) + L3*M4*MZ4*sin(q31L - ...
        q32L - q42L) + L3*M3*MY3*cos(q31L - q32L) + L3*M3*MZ3*sin(q31L - ...
        q32L) + L4*M4*MY4*cos(q31L - q32L + q41L - q42L) + L4*M4*MZ4* ...
       sin(q31L - q32L + q41L - q42L) + L4*M3*MY3*cos(q31L - q32L + ...
        q41L) + L3*L4*M4*sin(q31L - q32L + q41L) + L4*M3*MZ3*sin(q31L - ...
        q32L + q41L)) - dq32L*(L3^2*M4*sin(q31L - q32L) + L3*M4*MY4* ...
       cos(q31L - q32L - q42L) + L3*M4*MZ4*sin(q31L - q32L - q42L) + L3* ...
       M3*MY3*cos(q31L - q32L) + L3*M3*MZ3*sin(q31L - q32L) + L4*M4*MY4* ...
       cos(q31L - q32L + q41L - q42L) + L4*M4*MZ4*sin(q31L - q32L + ...
        q41L - q42L) + L4*M3*MY3*cos(q31L - q32L + q41L) + L3*L4*M4* ...
       sin(q31L - q32L + q41L) + L4*M3*MZ3*sin(q31L - q32L + q41L));
C(5,3)=L4*(dq1L + dq31L + dq41L)*(M4*MY4*cos(q31L - q32L + q41L - ...
        q42L) + M4*MZ4*sin(q31L - q32L + q41L - q42L) + M3*MY3* ...
       cos(q31L - q32L + q41L) + L3*M4*sin(q31L - q32L + q41L) + M3*MZ3* ...
       sin(q31L - q32L + q41L) + M1*MY1*cos(q31L + q41L) + M1*MZ1* ...
       sin(q31L + q41L) + M3*MY3*cos(q41L) - L3*M1*sin(q41L) - 2*L3*M3* ...
       sin(q41L) - L3*M4*sin(q41L) + M3*MZ3*sin(q41L));
C(5,4)=-M4*(dq1L + dq32L + dq42L)*(L4*MY4*cos(q31L - q32L + q41L - ...
        q42L) + L4*MZ4*sin(q31L - q32L + q41L - q42L) - L3*MY4* ...
       cos(q42L) + L3*MY4*cos(q31L - q32L - q42L) + L3*MZ4*sin(q42L) + ...
        L3*MZ4*sin(q31L - q32L - q42L));
C(5,5)=L3^2*M4*dq31L*sin(q31L - q32L) - L3^2*M4*dq32L*sin(q31L - q32L) + ...
        L4*M3*MY3*dq31L*cos(q31L - q32L + q41L) - L4*M3*MY3*dq32L* ...
       cos(q31L - q32L + q41L) + L4*M3*MY3*dq41L*cos(q31L - q32L + ...
        q41L) + L3*L4*M4*dq31L*sin(q31L - q32L + q41L) - L3*L4*M4*dq32L* ...
       sin(q31L - q32L + q41L) + L3*L4*M4*dq41L*sin(q31L - q32L + ...
        q41L) + L4*M3*MZ3*dq31L*sin(q31L - q32L + q41L) - L4*M3*MZ3* ...
       dq32L*sin(q31L - q32L + q41L) + L4*M3*MZ3*dq41L*sin(q31L - q32L + ...
        q41L) + L4*M1*MY1*dq31L*cos(q31L + q41L) + L4*M1*MY1*dq41L* ...
       cos(q31L + q41L) + L4*M1*MZ1*dq31L*sin(q31L + q41L) + L4*M1*MZ1* ...
       dq41L*sin(q31L + q41L) + L3*M1*MY1*dq31L*cos(q31L) + L4*M3*MY3* ...
       dq41L*cos(q41L) + L3*M4*MY4*dq42L*cos(q42L) + L3*M4*MY4*dq31L* ...
       cos(q31L - q32L - q42L) - L3*M4*MY4*dq32L*cos(q31L - q32L - ...
        q42L) - L3*M4*MY4*dq42L*cos(q31L - q32L - q42L) - L3*L4*M1* ...
       dq41L*sin(q41L) - 2*L3*L4*M3*dq41L*sin(q41L) - L3*L4*M4*dq41L* ...
       sin(q41L) + L3*M1*MZ1*dq31L*sin(q31L) + L4*M3*MZ3*dq41L* ...
       sin(q41L) - L3*M4*MZ4*dq42L*sin(q42L) + L3*M4*MZ4*dq31L* ...
       sin(q31L - q32L - q42L) - L3*M4*MZ4*dq32L*sin(q31L - q32L - ...
        q42L) - L3*M4*MZ4*dq42L*sin(q31L - q32L - q42L) + L3*M3*MY3* ...
       dq31L*cos(q31L - q32L) - L3*M3*MY3*dq32L*cos(q31L - q32L) + L3* ...
       M3*MZ3*dq31L*sin(q31L - q32L) - L3*M3*MZ3*dq32L*sin(q31L - ...
        q32L) + L4*M4*MY4*dq31L*cos(q31L - q32L + q41L - q42L) - L4*M4* ...
       MY4*dq32L*cos(q31L - q32L + q41L - q42L) + L4*M4*MY4*dq41L* ...
       cos(q31L - q32L + q41L - q42L) - L4*M4*MY4*dq42L*cos(q31L - ...
        q32L + q41L - q42L) + L4*M4*MZ4*dq31L*sin(q31L - q32L + q41L - ...
        q42L) - L4*M4*MZ4*dq32L*sin(q31L - q32L + q41L - q42L) + L4*M4* ...
       MZ4*dq41L*sin(q31L - q32L + q41L - q42L) - L4*M4*MZ4*dq42L* ...
       sin(q31L - q32L + q41L - q42L);

% G matrix
G=zeros(5,1);
G(1)=g*(M4*MY4*cos(q31L + q41L + q1L) + L4*M1*sin(q31L + q41L + q1L) + ...
      2*L4*M3*sin(q31L + q41L + q1L) + 2*L4*M4*sin(q31L + q41L + ...
      q1L) - M4*MZ4*sin(q31L + q41L + q1L) + M3*MY3*cos(q31L + q1L) + ...
      L3*M1*sin(q31L + q1L) + 2*L3*M3*sin(q31L + q1L) + L3*M4* ...
     sin(q31L + q1L) - M3*MZ3*sin(q31L + q1L));
G(2)=-g*(M4*MZ4*sin(q32L + q42L + q1L) - M4*MY4*cos(q32L + q42L + ...
      q1L) - M3*MY3*cos(q32L + q1L) + L3*M4*sin(q32L + q1L) + M3*MZ3* ...
     sin(q32L + q1L));
G(3)=g*(M4*MY4*cos(q31L + q41L + q1L) + L4*M1*sin(q31L + q41L + q1L) + ...
      2*L4*M3*sin(q31L + q41L + q1L) + 2*L4*M4*sin(q31L + q41L + ...
      q1L) - M4*MZ4*sin(q31L + q41L + q1L));
G(4)=M4*g*(MY4*cos(q32L + q42L + q1L) - MZ4*sin(q32L + q42L + q1L));
G(5)=g*(M4*MY4*cos(q31L + q41L + q1L) + M4*MY4*cos(q32L + q42L + ...
      q1L) + L4*M1*sin(q31L + q41L + q1L) + 2*L4*M3*sin(q31L + q41L + ...
      q1L) + 2*L4*M4*sin(q31L + q41L + q1L) - M4*MZ4*sin(q31L + q41L + ...
      q1L) - M4*MZ4*sin(q32L + q42L + q1L) + M3*MY3*cos(q31L + q1L) + ...
      M3*MY3*cos(q32L + q1L) + L3*M1*sin(q31L + q1L) + 2*L3*M3* ...
     sin(q31L + q1L) + L3*M4*sin(q31L + q1L) - L3*M4*sin(q32L + q1L) - ...
      M3*MZ3*sin(q31L + q1L) - M3*MZ3*sin(q32L + q1L) + M1*MY1* ...
     cos(q1L) - M1*MZ1*sin(q1L));

% B matrix
B=zeros(5,4);
B(1,1)=1;
B(2,2)=1;
B(3,3)=1;
B(4,4)=1;
