function [z] = zd_project(x)
% ZD_PROJECT
%   [Z] = ZD_PROJECT(X)  Project to the zero dynamics manifold.

%Eric Westervelt
%2016 Version: Peter Minh
%14-Nov-2016 14:25:57

modelP;

[nn,mm] = size(x);
if (nn > 1 & mm == 10)
  q31L=x(:,1); q32L=x(:,2); q41L=x(:,3); q42L=x(:,4); q1L=x(:,5);
  dq31L=x(:,6); dq32L=x(:,7); dq41L=x(:,8); dq42L=x(:,9); dq1L=x(:,10);
else
  q31L=x(1); q32L=x(2); q41L=x(3); q42L=x(4); q1L=x(5);
  dq31L=x(6); dq32L=x(7); dq41L=x(8); dq42L=x(9); dq1L=x(10);
end

% theta (in absolute coordinates)
z1 = - q31L - q41L./2 - q1L;

% gamma (in absolute coordinates)
z2 = dq31L.*(XX3 + XX4 + L3.^2.*M1 + L4.^2.*M1 + 2.*L3.^2.*M3 + ...
        L3.^2.*M4 + 2.*L4.^2.*M3 + 2.*L4.^2.*M4 + M3.*MY3.^2 + M4.* ...
       MY4.^2 + M3.*MZ3.^2 + M4.*MZ4.^2 - 2.*L3.*M3.*MZ3 - 2.*L4.*M4.* ...
       MZ4 - L3.^2.*M4.*cos(q31L - q32L) + 2.*L3.*L4.*M1.*cos(q41L) + ...
        4.*L3.*L4.*M3.*cos(q41L) + 2.*L3.*L4.*M4.*cos(q41L) - L3.*M1.* ...
       MZ1.*cos(q31L) - 2.*L4.*M3.*MZ3.*cos(q41L) - L3.*M4.*MZ4.* ...
       cos(q31L - q32L - q42L) + L3.*M1.*MY1.*sin(q31L) + 2.*L4.*M3.* ...
       MY3.*sin(q41L) + L3.*M4.*MY4.*sin(q31L - q32L - q42L) - L3.*M3.* ...
       MZ3.*cos(q31L - q32L) + L3.*M3.*MY3.*sin(q31L - q32L) - L4.*M4.* ...
       MZ4.*cos(q31L - q32L + q41L - q42L) + L4.*M4.*MY4.*sin(q31L - ...
        q32L + q41L - q42L) - L3.*L4.*M4.*cos(q31L - q32L + q41L) - L4.* ...
       M3.*MZ3.*cos(q31L - q32L + q41L) + L4.*M3.*MY3.*sin(q31L - q32L + ...
        q41L) - L4.*M1.*MZ1.*cos(q31L + q41L) + L4.*M1.*MY1.*sin(q31L + ...
        q41L)) + dq1L.*(XX1 + 2.*XX3 + 2.*XX4 + L3.^2.*M1 + L4.^2.*M1 + ...
        2.*L3.^2.*M3 + 2.*L3.^2.*M4 + 2.*L4.^2.*M3 + 2.*L4.^2.*M4 + M1.* ...
       MY1.^2 + 2.*M3.*MY3.^2 + 2.*M4.*MY4.^2 + M1.*MZ1.^2 + 2.*M3.* ...
       MZ3.^2 + 2.*M4.*MZ4.^2 - 2.*L3.*M3.*MZ3 - 2.*L4.*M4.*MZ4 - 2.* ...
       L3.^2.*M4.*cos(q31L - q32L) + 2.*L3.*L4.*M1.*cos(q41L) + 4.*L3.* ...
       L4.*M3.*cos(q41L) + 2.*L3.*L4.*M4.*cos(q41L) - 2.*L3.*M1.*MZ1.* ...
       cos(q31L) - 2.*L4.*M3.*MZ3.*cos(q41L) + 2.*L3.*M4.*MZ4.* ...
       cos(q42L) - 2.*L3.*M4.*MZ4.*cos(q31L - q32L - q42L) + 2.*L3.*M1.* ...
       MY1.*sin(q31L) + 2.*L4.*M3.*MY3.*sin(q41L) + 2.*L3.*M4.*MY4.* ...
       sin(q42L) + 2.*L3.*M4.*MY4.*sin(q31L - q32L - q42L) - 2.*L3.*M3.* ...
       MZ3.*cos(q31L - q32L) + 2.*L3.*M3.*MY3.*sin(q31L - q32L) - 2.* ...
       L4.*M4.*MZ4.*cos(q31L - q32L + q41L - q42L) + 2.*L4.*M4.*MY4.* ...
       sin(q31L - q32L + q41L - q42L) - 2.*L3.*L4.*M4.*cos(q31L - q32L + ...
        q41L) - 2.*L4.*M3.*MZ3.*cos(q31L - q32L + q41L) + 2.*L4.*M3.* ...
       MY3.*sin(q31L - q32L + q41L) - 2.*L4.*M1.*MZ1.*cos(q31L + q41L) + ...
        2.*L4.*M1.*MY1.*sin(q31L + q41L)) + dq41L.*(XX4 + L4.^2.*M1 + ...
        2.*L4.^2.*M3 + 2.*L4.^2.*M4 + M4.*MY4.^2 + M4.*MZ4.^2 - 2.*L4.* ...
       M4.*MZ4 + L3.*L4.*M1.*cos(q41L) + 2.*L3.*L4.*M3.*cos(q41L) + L3.* ...
       L4.*M4.*cos(q41L) - L4.*M3.*MZ3.*cos(q41L) + L4.*M3.*MY3.* ...
       sin(q41L) - L4.*M4.*MZ4.*cos(q31L - q32L + q41L - q42L) + L4.* ...
       M4.*MY4.*sin(q31L - q32L + q41L - q42L) - L3.*L4.*M4.*cos(q31L - ...
        q32L + q41L) - L4.*M3.*MZ3.*cos(q31L - q32L + q41L) + L4.*M3.* ...
       MY3.*sin(q31L - q32L + q41L) - L4.*M1.*MZ1.*cos(q31L + q41L) + ...
        L4.*M1.*MY1.*sin(q31L + q41L)) + dq32L.*(XX3 + XX4 + L3.^2.*M4 + ...
        M3.*MY3.^2 + M4.*MY4.^2 + M3.*MZ3.^2 + M4.*MZ4.^2 - L3.^2.*M4.* ...
       cos(q31L - q32L) + 2.*L3.*M4.*MZ4.*cos(q42L) - L3.*M4.*MZ4.* ...
       cos(q31L - q32L - q42L) + 2.*L3.*M4.*MY4.*sin(q42L) + L3.*M4.* ...
       MY4.*sin(q31L - q32L - q42L) - L3.*M3.*MZ3.*cos(q31L - q32L) + ...
        L3.*M3.*MY3.*sin(q31L - q32L) - L4.*M4.*MZ4.*cos(q31L - q32L + ...
        q41L - q42L) + L4.*M4.*MY4.*sin(q31L - q32L + q41L - q42L) - ...
        L3.*L4.*M4.*cos(q31L - q32L + q41L) - L4.*M3.*MZ3.*cos(q31L - ...
        q32L + q41L) + L4.*M3.*MY3.*sin(q31L - q32L + q41L)) + dq42L.* ...
       (XX4 + M4.*MY4.^2 + M4.*MZ4.^2 + L3.*M4.*MZ4.*cos(q42L) - L3.* ...
       M4.*MZ4.*cos(q31L - q32L - q42L) + L3.*M4.*MY4.*sin(q42L) + L3.* ...
       M4.*MY4.*sin(q31L - q32L - q42L) - L4.*M4.*MZ4.*cos(q31L - q32L + ...
        q41L - q42L) + L4.*M4.*MY4.*sin(q31L - q32L + q41L - q42L));

z3 = 0;
z = [z1 z2 z3];
