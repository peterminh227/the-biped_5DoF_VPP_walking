function [KE,PE] = kinetic_energy_5DoF(x)
% KINETIC_ENERGY_5DOF
%   [KE,PE] = KINETIC_ENERGY_5DOF(X)  

%Eric Westervelt
%2016 Version: Peter Minh
%05-Dec-2016 17:03:23

modelP;

[nn,mm] = size(x);

if nn ~= 1 & mm ~= 1
  KE = (M1.*(x(:,6).*(L3.*cos(x(:,1) + x(:,5)) + L4.*cos(x(:,1) + ...
        x(:,3) + x(:,5))) + x(:,10).*(L3.*cos(x(:,1) + x(:,5)) - MZ1.* ...
       cos(x(:,5)) - MY1.*sin(x(:,5)) + L4.*cos(x(:,1) + x(:,3) + ...
        x(:,5))) + L4.*x(:,8).*cos(x(:,1) + x(:,3) + x(:,5))).^2)./2 + ...
        (M4.*(x(:,10).*(L3.*sin(x(:,1) + x(:,5)) - L3.*sin(x(:,2) + ...
        x(:,5)) + MY4.*cos(x(:,2) + x(:,4) + x(:,5)) + L4.*sin(x(:,1) + ...
        x(:,3) + x(:,5)) - MZ4.*sin(x(:,2) + x(:,4) + x(:,5))) - ...
        x(:,7).*(L3.*sin(x(:,2) + x(:,5)) - MY4.*cos(x(:,2) + x(:,4) + ...
        x(:,5)) + MZ4.*sin(x(:,2) + x(:,4) + x(:,5))) + x(:,6).*(L3.* ...
       sin(x(:,1) + x(:,5)) + L4.*sin(x(:,1) + x(:,3) + x(:,5))) + ...
        x(:,9).*(MY4.*cos(x(:,2) + x(:,4) + x(:,5)) - MZ4.*sin(x(:,2) + ...
        x(:,4) + x(:,5))) + L4.*x(:,8).*sin(x(:,1) + x(:,3) + ...
        x(:,5))).^2)./2 + (XX3.*(x(:,10) + x(:,6)).^2)./2 + (XX3.* ...
       (x(:,10) + x(:,7)).^2)./2 + ((x(:,10) + x(:,6) + x(:,8)).^2.* ...
       (XX4 + L4.^2.*M4 + M4.*MY4.^2 + M4.*MZ4.^2 - 2.*L4.*M4.* ...
       MZ4))./2 + (M1.*(x(:,6).*(L3.*sin(x(:,1) + x(:,5)) + L4.* ...
       sin(x(:,1) + x(:,3) + x(:,5))) + x(:,10).*(L3.*sin(x(:,1) + ...
        x(:,5)) + MY1.*cos(x(:,5)) - MZ1.*sin(x(:,5)) + L4.*sin(x(:,1) + ...
        x(:,3) + x(:,5))) + L4.*x(:,8).*sin(x(:,1) + x(:,3) + ...
        x(:,5))).^2)./2 + (M3.*(x(:,10).*(L3.*cos(x(:,1) + x(:,5)) - ...
        MZ3.*cos(x(:,1) + x(:,5)) - MY3.*sin(x(:,1) + x(:,5)) + L4.* ...
       cos(x(:,1) + x(:,3) + x(:,5))) + x(:,6).*(L3.*cos(x(:,1) + ...
        x(:,5)) - MZ3.*cos(x(:,1) + x(:,5)) - MY3.*sin(x(:,1) + ...
        x(:,5)) + L4.*cos(x(:,1) + x(:,3) + x(:,5))) + L4.*x(:,8).* ...
       cos(x(:,1) + x(:,3) + x(:,5))).^2)./2 + (XX1.*x(:,10).^2)./2 + ...
        (M3.*(x(:,6).*(L3.*cos(x(:,1) + x(:,5)) + L4.*cos(x(:,1) + ...
        x(:,3) + x(:,5))) - x(:,7).*(MZ3.*cos(x(:,2) + x(:,5)) + MY3.* ...
       sin(x(:,2) + x(:,5))) + x(:,10).*(L3.*cos(x(:,1) + x(:,5)) - ...
        MZ3.*cos(x(:,2) + x(:,5)) - MY3.*sin(x(:,2) + x(:,5)) + L4.* ...
       cos(x(:,1) + x(:,3) + x(:,5))) + L4.*x(:,8).*cos(x(:,1) + ...
        x(:,3) + x(:,5))).^2)./2 + (M4.*(x(:,7).*(L3.*cos(x(:,2) + ...
        x(:,5)) + MZ4.*cos(x(:,2) + x(:,4) + x(:,5)) + MY4.*sin(x(:,2) + ...
        x(:,4) + x(:,5))) + x(:,10).*(L3.*cos(x(:,2) + x(:,5)) - L3.* ...
       cos(x(:,1) + x(:,5)) - L4.*cos(x(:,1) + x(:,3) + x(:,5)) + MZ4.* ...
       cos(x(:,2) + x(:,4) + x(:,5)) + MY4.*sin(x(:,2) + x(:,4) + ...
        x(:,5))) - x(:,6).*(L3.*cos(x(:,1) + x(:,5)) + L4.*cos(x(:,1) + ...
        x(:,3) + x(:,5))) + x(:,9).*(MZ4.*cos(x(:,2) + x(:,4) + ...
        x(:,5)) + MY4.*sin(x(:,2) + x(:,4) + x(:,5))) - L4.*x(:,8).* ...
       cos(x(:,1) + x(:,3) + x(:,5))).^2)./2 + (XX4.*(x(:,10) + x(:,7) + ...
        x(:,9)).^2)./2 + (M3.*(x(:,10).*(MY3.*cos(x(:,1) + x(:,5)) + ...
        L3.*sin(x(:,1) + x(:,5)) - MZ3.*sin(x(:,1) + x(:,5)) + L4.* ...
       sin(x(:,1) + x(:,3) + x(:,5))) + x(:,6).*(MY3.*cos(x(:,1) + ...
        x(:,5)) + L3.*sin(x(:,1) + x(:,5)) - MZ3.*sin(x(:,1) + x(:,5)) + ...
        L4.*sin(x(:,1) + x(:,3) + x(:,5))) + L4.*x(:,8).*sin(x(:,1) + ...
        x(:,3) + x(:,5))).^2)./2 + (M3.*(x(:,10).*(MY3.*cos(x(:,2) + ...
        x(:,5)) + L3.*sin(x(:,1) + x(:,5)) - MZ3.*sin(x(:,2) + x(:,5)) + ...
        L4.*sin(x(:,1) + x(:,3) + x(:,5))) + x(:,6).*(L3.*sin(x(:,1) + ...
        x(:,5)) + L4.*sin(x(:,1) + x(:,3) + x(:,5))) + x(:,7).*(MY3.* ...
       cos(x(:,2) + x(:,5)) - MZ3.*sin(x(:,2) + x(:,5))) + L4.*x(:,8).* ...
       sin(x(:,1) + x(:,3) + x(:,5))).^2)./2;
else
  KE = (M1*(x(6)*(L3*cos(x(1) + x(5)) + L4*cos(x(1) + x(3) + x(5))) + ...
        x(10)*(L3*cos(x(1) + x(5)) - MZ1*cos(x(5)) - MY1*sin(x(5)) + L4* ...
       cos(x(1) + x(3) + x(5))) + L4*x(8)*cos(x(1) + x(3) + ...
        x(5)))^2)/2 + (M4*(x(10)*(L3*sin(x(1) + x(5)) - L3*sin(x(2) + ...
        x(5)) + MY4*cos(x(2) + x(4) + x(5)) + L4*sin(x(1) + x(3) + ...
        x(5)) - MZ4*sin(x(2) + x(4) + x(5))) - x(7)*(L3*sin(x(2) + ...
        x(5)) - MY4*cos(x(2) + x(4) + x(5)) + MZ4*sin(x(2) + x(4) + ...
        x(5))) + x(6)*(L3*sin(x(1) + x(5)) + L4*sin(x(1) + x(3) + ...
        x(5))) + x(9)*(MY4*cos(x(2) + x(4) + x(5)) - MZ4*sin(x(2) + ...
        x(4) + x(5))) + L4*x(8)*sin(x(1) + x(3) + x(5)))^2)/2 + (XX3* ...
       (x(10) + x(6))^2)/2 + (XX3*(x(10) + x(7))^2)/2 + ((x(10) + x(6) + ...
        x(8))^2*(XX4 + L4^2*M4 + M4*MY4^2 + M4*MZ4^2 - 2*L4*M4*MZ4))/2 + ...
        (M1*(x(6)*(L3*sin(x(1) + x(5)) + L4*sin(x(1) + x(3) + x(5))) + ...
        x(10)*(L3*sin(x(1) + x(5)) + MY1*cos(x(5)) - MZ1*sin(x(5)) + L4* ...
       sin(x(1) + x(3) + x(5))) + L4*x(8)*sin(x(1) + x(3) + ...
        x(5)))^2)/2 + (M3*(x(10)*(L3*cos(x(1) + x(5)) - MZ3*cos(x(1) + ...
        x(5)) - MY3*sin(x(1) + x(5)) + L4*cos(x(1) + x(3) + x(5))) + ...
        x(6)*(L3*cos(x(1) + x(5)) - MZ3*cos(x(1) + x(5)) - MY3* ...
       sin(x(1) + x(5)) + L4*cos(x(1) + x(3) + x(5))) + L4*x(8)* ...
       cos(x(1) + x(3) + x(5)))^2)/2 + (XX1*x(10)^2)/2 + (M3*(x(6)*(L3* ...
       cos(x(1) + x(5)) + L4*cos(x(1) + x(3) + x(5))) - x(7)*(MZ3* ...
       cos(x(2) + x(5)) + MY3*sin(x(2) + x(5))) + x(10)*(L3*cos(x(1) + ...
        x(5)) - MZ3*cos(x(2) + x(5)) - MY3*sin(x(2) + x(5)) + L4* ...
       cos(x(1) + x(3) + x(5))) + L4*x(8)*cos(x(1) + x(3) + ...
        x(5)))^2)/2 + (M4*(x(7)*(L3*cos(x(2) + x(5)) + MZ4*cos(x(2) + ...
        x(4) + x(5)) + MY4*sin(x(2) + x(4) + x(5))) + x(10)*(L3* ...
       cos(x(2) + x(5)) - L3*cos(x(1) + x(5)) - L4*cos(x(1) + x(3) + ...
        x(5)) + MZ4*cos(x(2) + x(4) + x(5)) + MY4*sin(x(2) + x(4) + ...
        x(5))) - x(6)*(L3*cos(x(1) + x(5)) + L4*cos(x(1) + x(3) + ...
        x(5))) + x(9)*(MZ4*cos(x(2) + x(4) + x(5)) + MY4*sin(x(2) + ...
        x(4) + x(5))) - L4*x(8)*cos(x(1) + x(3) + x(5)))^2)/2 + (XX4* ...
       (x(10) + x(7) + x(9))^2)/2 + (M3*(x(10)*(MY3*cos(x(1) + x(5)) + ...
        L3*sin(x(1) + x(5)) - MZ3*sin(x(1) + x(5)) + L4*sin(x(1) + ...
        x(3) + x(5))) + x(6)*(MY3*cos(x(1) + x(5)) + L3*sin(x(1) + ...
        x(5)) - MZ3*sin(x(1) + x(5)) + L4*sin(x(1) + x(3) + x(5))) + L4* ...
       x(8)*sin(x(1) + x(3) + x(5)))^2)/2 + (M3*(x(10)*(MY3*cos(x(2) + ...
        x(5)) + L3*sin(x(1) + x(5)) - MZ3*sin(x(2) + x(5)) + L4* ...
       sin(x(1) + x(3) + x(5))) + x(6)*(L3*sin(x(1) + x(5)) + L4* ...
       sin(x(1) + x(3) + x(5))) + x(7)*(MY3*cos(x(2) + x(5)) - MZ3* ...
       sin(x(2) + x(5))) + L4*x(8)*sin(x(1) + x(3) + x(5)))^2)/2;
end
[nn,mm] = size(x);

if nn ~= 1 & mm ~= 1
  PE = g.*(M4.*MZ4.*cos(x(:,1) + x(:,3) + x(:,5)) - 2.*L4.*M3.* ...
       cos(x(:,1) + x(:,3) + x(:,5)) - 2.*L4.*M4.*cos(x(:,1) + x(:,3) + ...
        x(:,5)) - L4.*M1.*cos(x(:,1) + x(:,3) + x(:,5)) + M4.*MZ4.* ...
       cos(x(:,2) + x(:,4) + x(:,5)) + M4.*MY4.*sin(x(:,1) + x(:,3) + ...
        x(:,5)) + M4.*MY4.*sin(x(:,2) + x(:,4) + x(:,5)) - L3.*M1.* ...
       cos(x(:,1) + x(:,5)) - 2.*L3.*M3.*cos(x(:,1) + x(:,5)) - L3.*M4.* ...
       cos(x(:,1) + x(:,5)) + L3.*M4.*cos(x(:,2) + x(:,5)) + M3.*MZ3.* ...
       cos(x(:,1) + x(:,5)) + M3.*MZ3.*cos(x(:,2) + x(:,5)) + M3.*MY3.* ...
       sin(x(:,1) + x(:,5)) + M3.*MY3.*sin(x(:,2) + x(:,5)) + M1.*MZ1.* ...
       cos(x(:,5)) + M1.*MY1.*sin(x(:,5)));
else
  PE = g*(M4*MZ4*cos(x(1) + x(3) + x(5)) - 2*L4*M3*cos(x(1) + x(3) + ...
        x(5)) - 2*L4*M4*cos(x(1) + x(3) + x(5)) - L4*M1*cos(x(1) + ...
        x(3) + x(5)) + M4*MZ4*cos(x(2) + x(4) + x(5)) + M4*MY4* ...
       sin(x(1) + x(3) + x(5)) + M4*MY4*sin(x(2) + x(4) + x(5)) - L3*M1* ...
       cos(x(1) + x(5)) - 2*L3*M3*cos(x(1) + x(5)) - L3*M4*cos(x(1) + ...
        x(5)) + L3*M4*cos(x(2) + x(5)) + M3*MZ3*cos(x(1) + x(5)) + M3* ...
       MZ3*cos(x(2) + x(5)) + M3*MY3*sin(x(1) + x(5)) + M3*MY3* ...
       sin(x(2) + x(5)) + M1*MZ1*cos(x(5)) + M1*MY1*sin(x(5)));
end
